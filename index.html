<!doctype html>
<html lang="ar">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat - 1383</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-dark: #1a1a2e;
        --bg-light: #2c2c44;
        --text-color: #e0e0e0;
        --border-color: #44445c;
        --input-bg: #3c3c54;
        --other-message-bg: #f0f2f5;
        --other-message-text-color: #333;
        --accent-color: #0b5edd;
        --hover-color: #0d6efd;
        --sidebar-width: 250px;
        --chat-bg-image: none;
        --chat-bg-color: var(--bg-dark);
        --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        --font-size: 15px;
        --my-message-bg: var(--accent-color);
        --my-message-text-color: #fff;
        --system-message-bg: #444;
        --system-message-text-color: #fff;
        --other-user-color: #0b5edd;
      }
      .light-theme {
        --bg-dark: #f0f2f5;
        --bg-light: #ffffff;
        --text-color: #333333;
        --border-color: #e0e0e0;
        --input-bg: #f6f7fb;
        --other-message-bg: #f6f7fb;
        --other-message-text-color: #333;
        --accent-color: #0b5edd;
        --hover-color: #0d6efd;
        --my-message-bg: var(--accent-color);
        --my-message-text-color: #fff;
        --other-user-color: #0b5edd;
      }
      body {
        font-family: var(--font-family);
        font-size: var(--font-size);
        background: var(--bg-dark);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        transition: background-color 0.3s ease;
      }
      .app {
        display: flex;
        width: 100%;
        height: 100%;
        position: relative;
      }
      .sidebar-toggle-btn {
        position: fixed;
        top: 15px;
        left: 15px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--accent-color);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 18px;
        z-index: 100;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: left 0.3s ease, transform 0.3s ease;
      }
      .sidebar-toggle-btn.active {
          left: calc(var(--sidebar-width) + 15px);
          transform: rotate(180deg);
      }
      .sidebar {
        width: var(--sidebar-width);
        background: var(--bg-light);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 15px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        position: fixed;
        height: 100%;
        left: 0;
        top: 0;
        z-index: 99;
      }
      .sidebar.active {
        transform: translateX(0);
      }
      @media (min-width: 768px) {
        .sidebar {
          transform: translateX(0);
          position: relative;
        }
        .sidebar-toggle-btn {
          display: none;
        }
        .app {
          flex-direction: row;
        }
      }
      @media (max-width: 767px) {
        .app {
            flex-direction: column;
        }
        .chat-main {
            width: 100%;
            height: 100%;
        }
      }
      .sidebar h3 {
        color: var(--text-color);
        margin-top: 0;
        margin-bottom: 20px;
        text-align: center;
      }
      .user-info {
        font-size: 14px;
        margin-bottom: 20px;
        color: var(--text-color);
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
      }
      .room-list {
        flex-grow: 1;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .room-list li {
        margin-bottom: 8px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: none;
        border: 1px solid transparent;
        border-radius: 5px;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }
      .room-list li:hover {
        background-color: var(--input-bg);
      }
      .room-list button {
        background: none;
        border: none;
        color: var(--text-color);
        padding: 10px 15px;
        text-align: right;
        flex-grow: 1;
        cursor: pointer;
      }
      .room-list button.active {
        background-color: var(--accent-color);
        color: white;
      }
      .leave-room-btn, .games-menu-btn {
          background: none;
          border: none;
          cursor: pointer;
          font-size: 14px;
          padding: 10px;
          display: block;
          margin-left: 5px;
      }
      .leave-room-btn {
          color: #e74c3c;
      }
      .games-menu-btn {
          color: #2ecc71;
      }
      .room-list button.active + .games-menu-btn,
      .room-list button.active + .games-menu-btn + .leave-room-btn {
          color: white;
      }
      .add-room-btn {
        width: 100%;
        padding: 12px;
        margin-top: 20px;
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        transition: background-color 0.2s ease;
      }
      .add-room-btn:hover {
        background-color: var(--hover-color);
      }
      .chat-main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background: var(--chat-bg-color);
        background-image: var(--chat-bg-image);
        background-size: cover;
        background-position: center;
      }
      .chat-header {
        background: var(--bg-light);
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .chat-header h2 {
        margin: 0;
        font-size: 18px;
        color: var(--text-color);
      }
      .dm-header-info {
        font-size: 12px;
        color: #aaa;
        margin-top: 5px;
      }
      .header-actions {
          display: flex;
          gap: 10px;
      }
      .settings-btn {
          background: none;
          border: none;
          color: var(--text-color);
          font-size: 20px;
          cursor: pointer;
          transition: color 0.2s ease;
      }
      .settings-btn:hover {
          color: var(--accent-color);
      }
      .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 15px 20px;
        display: flex;
        flex-direction: column;
      }
      .message-wrapper {
        display: flex;
        margin-bottom: 15px;
      }
      .message-wrapper.me {
        justify-content: flex-end;
      }
      .message-wrapper.other {
        justify-content: flex-start;
      }
      .message-wrapper.system {
          justify-content: center;
          text-align: center;
      }
      .message-wrapper.gemini {
          justify-content: flex-start;
          text-align: right;
      }
      .message-content {
        max-width: 70%;
        padding: 12px 15px;
        border-radius: 18px;
        line-height: 1.4;
        position: relative;
        word-wrap: break-word;
      }
      .message-wrapper.me .message-content {
        background: var(--my-message-bg);
        color: var(--my-message-text-color);
        border-bottom-right-radius: 4px;
      }
      .message-wrapper.other .message-content {
        background: var(--other-message-bg);
        color: var(--other-message-text-color);
        border-bottom-left-radius: 4px;
      }
      .message-wrapper.gemini .message-content {
          background-color: #2c3e50 !important;
          color: #ecf0f1;
      }
      .message-wrapper.system .message-content {
          background-color: var(--system-message-bg);
          color: var(--system-message-text-color);
          font-size: 12px;
          font-style: italic;
      }
      .message-meta {
        font-size: 11px;
        opacity: 0.7;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
      }
      .message-wrapper.me .message-meta {
        text-align: right;
        flex-direction: row-reverse;
      }
      .message-wrapper.other .message-meta {
        text-align: left;
      }
      .read-receipts {
        font-size: 10px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }
      .read-receipts .fa-check {
          color: #a0a0a0;
      }
      .read-receipts .seen {
          color: var(--accent-color);
      }
      .message-composer {
        display: flex;
        padding: 15px 20px;
        background: var(--bg-light);
        border-top: 1px solid var(--border-color);
        gap: 10px;
        position: relative;
      }
      .message-composer textarea {
        flex: 1;
        padding: 12px 15px;
        border-radius: 25px;
        border: 1px solid var(--border-color);
        background: var(--input-bg);
        color: var(--text-color);
        font-size: 15px;
        outline: none;
        resize: none;
        min-height: 20px;
        max-height: 150px;
        font-family: var(--font-family);
      }
      .message-composer textarea::placeholder {
        color: #999;
      }
      .message-composer button {
        padding: 12px 20px;
        border-radius: 25px;
        border: none;
        background: var(--accent-color);
        color: white;
        cursor: pointer;
        font-size: 15px;
        transition: background-color 0.2s ease;
      }
      .message-composer button:hover {
        background-color: var(--hover-color);
      }
      .message-composer .icon-btn {
          width: 50px;
          padding: 0;
          border-radius: 50%;
          background: #2ecc71;
      }
      .message-composer .icon-btn i {
          font-size: 20px;
      }
      .message-composer .voice-btn { background: #3498db; }
      .message-composer .camera-btn { background: #9b59b6; }
      .room-initial-selection {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 20px;
        background-color: var(--bg-dark);
      }
      .room-initial-selection h2 {
        color: var(--text-color);
        margin-bottom: 20px;
      }
      .room-initial-selection p {
        color: #aaa;
        margin-bottom: 30px;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
      }
      .modal-content {
        background-color: var(--bg-light);
        margin: 5% auto;
        padding: 20px;
        border: 1px solid var(--border-color);
        width: 80%;
        max-width: 500px;
        border-radius: 10px;
      }
      .modal-content h3 {
          margin-top: 0;
          color: var(--text-color);
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .close:hover,
      .close:focus {
        color: #e74c3c;
        text-decoration: none;
        cursor: pointer;
      }
      .color-options {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          justify-content: center;
          flex-wrap: wrap;
      }
      .color-option {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 2px solid transparent;
          cursor: pointer;
          transition: border-color 0.2s ease;
      }
      .color-option:hover {
          border-color: var(--accent-color);
      }
      .color-option.selected {
          border-color: var(--accent-color);
          box-shadow: 0 0 0 3px var(--accent-color);
      }
      .theme-options {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
      }
      .theme-options button {
          padding: 10px;
          border: 1px solid var(--border-color);
          border-radius: 5px;
          background-color: var(--input-bg);
          color: var(--text-color);
          cursor: pointer;
      }
      .theme-options button.selected {
          background-color: var(--accent-color);
          color: white;
      }
      .setting-group {
          margin-bottom: 20px;
      }
      .setting-group label {
          display: block;
          margin-bottom: 5px;
          color: var(--text-color);
      }
      .setting-group input, .setting-group select {
          width: 100%;
          padding: 10px;
          box-sizing: border-box;
          border-radius: 5px;
          border: 1px solid var(--border-color);
          background-color: var(--input-bg);
          color: var(--text-color);
          margin-bottom: 10px;
      }
      .message-options {
          position: fixed;
          background-color: var(--bg-light);
          border: 1px solid var(--border-color);
          border-radius: 5px;
          padding: 5px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          display: none;
          z-index: 1000;
          white-space: nowrap;
          transform: translate(-50%, -50%);
          left: 50%;
          top: 50%;
      }
      .message-options button {
          background: none;
          border: none;
          color: var(--text-color);
          padding: 8px 12px;
          width: 100%;
          text-align: right;
          cursor: pointer;
      }
      .message-options button:hover {
          background-color: var(--input-bg);
      }
      .kick-user-btn {
        background: #e74c3c !important;
        color: white !important;
        margin-top: 10px;
      }
      .kick-user-btn:hover {
        background: #c0392b !important;
      }
      .recording-status {
        color: #e74c3c;
        font-size: 12px;
        margin-right: 10px;
        display: none;
      }

      /* Members Modal Styles */
      .members-modal-content {
          background-color: var(--bg-light);
          margin: 5% auto;
          padding: 20px;
          border: 1px solid var(--border-color);
          width: 80%;
          max-width: 400px;
          border-radius: 10px;
      }
      .members-modal-content h3 {
          margin-top: 0;
          color: var(--text-color);
      }
      .members-list {
          list-style: none;
          padding: 0;
          max-height: 200px;
          overflow-y: auto;
      }
      .members-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
      }
      .members-list li:hover {
        background-color: var(--input-bg);
      }
      .members-list li:last-child {
        border-bottom: none;
      }
      .members-list .member-name {
        font-weight: bold;
      }
      .members-list .kick-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
      }
      .members-list .kick-btn:hover {
        background-color: #c0392b;
      }
      .add-member-form {
          display: flex;
          margin-top: 20px;
          gap: 10px;
      }
      .add-member-form input {
          flex: 1;
          padding: 8px;
          border-radius: 5px;
          border: 1px solid var(--border-color);
          background-color: var(--input-bg);
          color: var(--text-color);
      }
      .add-member-form button {
          background-color: var(--accent-color);
          color: white;
          border: none;
          padding: 8px 12px;
          border-radius: 5px;
          cursor: pointer;
      }

      /* Profile Modal */
      #profileModal .modal-content {
          max-width: 400px;
          text-align: center;
      }
      #profileModal h3 {
          margin-bottom: 10px;
      }
      #profileModal p {
          color: #aaa;
          margin: 5px 0;
      }
      
      /* Login/Signup Styles */
      .login-container {
          background-color: #2c2c44;
          padding: 40px;
          border-radius: 10px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
          width: 90%;
          max-width: 400px;
          text-align: center;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
      }
      .login-container h2 {
          margin-bottom: 20px;
          color: #fff;
      }
      .input-group {
          margin-bottom: 20px;
          text-align: right;
      }
      .input-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: bold;
          color: #fff;
      }
      .input-group input {
          width: 100%;
          padding: 12px;
          border: 1px solid #44445c;
          border-radius: 5px;
          background-color: #3c3c54;
          color: #e0e0e0;
          font-size: 16px;
          box-sizing: border-box;
          direction: rtl;
      }
      .input-group input:focus {
          outline: none;
          border-color: #0b5edd;
      }
      .btn {
          width: 100%;
          padding: 12px;
          border: none;
          border-radius: 5px;
          background-color: #0b5edd;
          color: #fff;
          font-size: 16px;
          cursor: pointer;
          transition: background-color 0.2s ease;
      }
      .btn:hover {
          background-color: #0d6efd;
      }
      .toggle-btn {
          background: none;
          color: #0b5edd;
          border: none;
          cursor: pointer;
          margin-top: 15px;
          font-size: 14px;
          text-decoration: underline;
      }
      .message {
          color: #e74c3c;
          margin-top: 10px;
          display: none;
      }
      .success-message {
          color: #2ecc71;
      }

      /* Autocomplete Suggestions */
      #autocomplete-suggestions {
          position: absolute;
          bottom: 100%;
          left: 0;
          right: 0;
          background-color: var(--bg-light);
          border: 1px solid var(--border-color);
          border-radius: 8px;
          margin-bottom: 5px;
          max-height: 150px;
          overflow-y: auto;
          box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
          z-index: 50;
          display: none;
      }
      #autocomplete-suggestions ul {
          list-style: none;
          padding: 0;
          margin: 0;
      }
      #autocomplete-suggestions li {
          padding: 10px 15px;
          cursor: pointer;
          color: var(--text-color);
      }
      #autocomplete-suggestions li:hover {
          background-color: var(--input-bg);
      }

      /* Date Separator */
      .date-separator {
          text-align: center;
          margin: 15px 0;
          position: relative;
      }
      .date-separator span {
          background-color: var(--bg-light);
          padding: 5px 15px;
          border-radius: 15px;
          font-size: 12px;
          color: var(--text-color);
          border: 1px solid var(--border-color);
      }

      /* Reply Feature */
      .reply-indicator {
          background-color: var(--input-bg);
          padding: 8px 12px;
          border-radius: 8px;
          margin-bottom: 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-right: 3px solid var(--accent-color);
      }
      .reply-indicator .reply-text {
          font-size: 13px;
          color: var(--text-color);
          flex: 1;
          margin-right: 10px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
      }
      .reply-indicator .cancel-reply {
          background: none;
          border: none;
          color: var(--text-color);
          cursor: pointer;
          font-size: 14px;
      }
      .reply-to {
          font-size: 12px;
          opacity: 0.7;
          margin-bottom: 4px;
          display: block;
      }
      .reply-btn {
          background: none;
          border: none;
          color: var(--text-color);
          cursor: pointer;
          font-size: 12px;
          margin-top: 5px;
          opacity: 0.7;
      }
      .reply-btn:hover {
          opacity: 1;
      }

      /* DM Styles */
      .dm-indicator {
          display: inline-block;
          background-color: #2ecc71;
          color: white;
          font-size: 10px;
          padding: 2px 6px;
          border-radius: 10px;
          margin-left: 5px;
          vertical-align: middle;
      }
      .online-status {
          display: inline-block;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background-color: #2ecc71;
          margin-left: 5px;
      }
      .typing-status {
          font-size: 12px;
          font-style: italic;
          color: var(--accent-color);
          margin-left: 5px;
      }
      .last-seen {
          font-size: 11px;
          opacity: 0.7;
          margin-left: 5px;
      }
      
      /* Hide elements initially */
      #displayNameGroup {
          display: none;
      }
    </style>
  </head>
  <body>
    <div id="loginSection" class="login-container">
        <h2 id="formTitle">تسجيل الدخول</h2>
        <p id="formDescription">لا يمكنك استخدام التطبيق بدون تسجيل الدخول أو إنشاء حساب جديد.</p>
        
        <div class="input-group">
            <label for="username">اسم المستخدم</label>
            <input type="text" id="username" name="username" placeholder="أدخل اسم المستخدم" required>
        </div>
        
        <div class="input-group">
            <label for="password">كلمة المرور</label>
            <input type="password" id="password" name="password" placeholder="أدخل كلمة المرور" required>
        </div>
        
        <div id="displayNameGroup" class="input-group">
            <label for="displayName">اسم العرض</label>
            <input type="text" id="displayName" name="displayName" placeholder="اختر اسم للعرض" required>
        </div>
        
        <button id="mainBtn" class="btn">تسجيل الدخول</button>
        <p id="message" class="message"></p>
        <button id="toggleForm" class="toggle-btn">
            لا تملك حسابًا؟ إنشاء حساب
        </button>
    </div>

    <div id="chatSection" class="app" style="display: none;">
      <button id="sidebarToggleBtn" class="sidebar-toggle-btn"><i class="fas fa-bars"></i></button>

      <div id="sidebar" class="sidebar">
        <div class="user-info">
          مرحباً بك: <span id="meName"></span>
        </div>
        <h3>الغرف المتاحة</h3>
        <ul id="roomList" class="room-list"></ul>
        <button class="add-room-btn" id="addRoomBtn">انضم/أنشئ غرفة</button>
        <button class="add-room-btn" id="addDMBtn" style="margin-top: 10px;">إضافة محادثة خاصة</button>
      </div>

      <div class="chat-main">
        <div id="roomInitialSelection" class="room-initial-selection">
          <h2>أهلاً بك في الشات!</h2>
          <p>اختر غرفة من القائمة الجانبية أو انشئ/انضم لغرفة جديدة للبدء.</p>
        </div>

        <div id="chatRoomArea" style="display: none; height: 100%; flex-direction: column;">
          <div class="chat-header">
            <div>
              <h2 id="currentRoomName"></h2>
              <div id="dmHeaderInfo" class="dm-header-info" style="display: none;"></div>
            </div>
            <div class="header-actions">
              <button class="settings-btn" id="aboutBtn"><i class="fas fa-info-circle"></i></button>
              <button class="settings-btn" id="membersBtn"><i class="fas fa-users"></i></button>
              <button class="settings-btn" id="roomSettingsBtn"><i class="fas fa-cog"></i></button>
              <button class="settings-btn" id="userSettingsBtn"><i class="fas fa-user-cog"></i></button>
            </div>
          </div>
          <div id="messagesArea" class="messages-area"></div>
          <div id="replyIndicator" class="reply-indicator" style="display: none;">
            <div class="reply-text" id="replyText"></div>
            <button class="cancel-reply" id="cancelReply"><i class="fas fa-times"></i></button>
          </div>
          <div class="message-composer">
            <div id="autocomplete-suggestions">
                <ul>
                    <li id="gemi-suggestion">@gemini</li>
                </ul>
            </div>
            <span id="recordingStatus" class="recording-status">تسجيل...</span>
            <textarea id="textInput" placeholder="اكتب رسالتك..." autocomplete="off"></textarea>
            <button class="icon-btn" id="fileBtn"><i class="fas fa-paperclip"></i></button>
            <input type="file" id="fileInput" style="display: none;" />
            <button class="icon-btn voice-btn" id="voiceBtn"><i class="fas fa-microphone"></i></button>
            <button class="icon-btn camera-btn" id="cameraBtn"><i class="fas fa-camera"></i></button>
            <input type="file" id="cameraInput" accept="image/*" style="display: none;" capture="user" />
            <button id="sendBtn">إرسال</button>
          </div>
        </div>
      </div>
    </div>

    <!-- بقية الـ modals -->
    <div id="userSettingsModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeUserSettingsModal">&times;</span>
        <h3>إعدادات المستخدم</h3>
        <div class="setting-group">
            <label for="usernameInput">تغيير اسم العرض</label>
            <input type="text" id="usernameInput" placeholder="أدخل اسمك الجديد" />
            <button id="saveUsernameBtn">حفظ الاسم</button>
        </div>
        <div class="setting-group">
            <label for="bioInput">النبذة الشخصية</label>
            <input type="text" id="bioInput" placeholder="اكتب نبذة مختصرة عنك" />
        </div>
        <div class="setting-group">
            <label>اختر لون رسائلك</label>
            <div id="colorOptions" class="color-options">
              <div class="color-option" data-color="#0b5edd" style="background-color: #0b5edd;"></div>
              <div class="color-option" data-color="#2ecc71" style="background-color: #2ecc71;"></div>
              <div class="color-option" data-color="#e74c3c" style="background-color: #e74c3c;"></div>
              <div class="color-option" data-color="#f39c12" style="background-color: #f39c12;"></div>
              <div class="color-option" data-color="#9b59b6" style="background-color: #9b59b6;"></div>
            </div>
        </div>
        <div class="setting-group">
            <label>اختر لون رسائل الآخرين</label>
            <div id="otherColorOptions" class="color-options">
              <div class="color-option" data-color="#0b5edd" style="background-color: #0b5edd;"></div>
              <div class="color-option" data-color="#2ecc71" style="background-color: #2ecc71;"></div>
              <div class="color-option" data-color="#e74c3c" style="background-color: #e74c3c;"></div>
              <div class="color-option" data-color="#f39c12" style="background-color: #f39c12;"></div>
              <div class="color-option" data-color="#9b59b6" style="background-color: #9b59b6;"></div>
            </div>
        </div>
        <div class="setting-group">
            <label>اختر ثيم البرنامج</label>
            <div id="themeOptions" class="theme-options">
                <button data-theme="dark" class="selected">داكن</button>
                <button data-theme="light">فاتح</button>
            </div>
        </div>
        <div class="setting-group">
            <label for="fontFamilySelect">نوع الخط</label>
            <select id="fontFamilySelect">
                <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                <option value="'Arial', sans-serif">Arial</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="'Cairo', sans-serif">Cairo</option>
                <option value="'Tajawal', sans-serif">Tajawal</option>
                <option value="'Georgia', serif">Georgia</option>
                <option value="'Verdana', sans-serif">Verdana</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="fontSizeSelect">حجم الخط</label>
            <select id="fontSizeSelect">
                <option value="14px">صغير</option>
                <option value="15px">متوسط</option>
                <option value="16px">كبير</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="chatBackgroundInput">خلفية الشات (صورة/لون)</label>
            <input type="text" id="chatBackgroundInput" placeholder="أدخل رابط صورة أو كود لون (#000)" />
            <button id="saveBackgroundBtn">حفظ الخلفية</button>
        </div>
        <button id="logoutBtn" class="btn" style="background-color: #e74c3c;">تسجيل خروج</button>
      </div>
    </div>
    
    <div id="roomSettingsModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeRoomSettingsModal">&times;</span>
        <h3>إعدادات الغرفة</h3>
        <div class="setting-group">
            <label>مالك الغرفة:</label>
            <p id="roomOwnerName"></p>
        </div>
        <div class="setting-group">
            <button id="leaveRoomBtn" class="btn" style="background-color: #f39c12;">الخروج من الغرفة</button>
            <button id="deleteRoomBtn" class="btn" style="background-color: #e74c3c; display: none;">حذف الغرفة</button>
        </div>
      </div>
    </div>

    <div id="aboutModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAboutModal">&times;</span>
        <h3 style="font-size: 24px; color: #e74c3c; margin-bottom: 20px;">Developed By Sara_1383</h3>
        <h3>عن التطبيق</h3>
        <p>أهلاً بك في تطبيق الدردشة متعدد الغرف. أهم الميزات في التطبيق هي:</p>
        <ul>
            <li>**دردشة جماعية:** تقدر تنضم أو تعمل غرف دردشة مختلفة.</li>
            <li>**إعدادات شخصية:** تقدر تعدل على مظهر الشات وألوان رسائلك عشان تخليه مناسب ليك.</li>
            <li>**مشاركة الملفات:** تقدر ترفع وتشارك الصور والملفات بسهولة.</li>
            <li>**دردشة خاصة:** تقدر تعمل محادثات خاصة مع أي مستخدم.</li>
            <li>**إدارة الغرف:** تقدر تضيف أعضاء أو تطردهم من الغرف.</li>
            <li>**إضافة @gemini:** تقدر تستخدم الذكاء الاصطناعي في الشات.</li>
        </ul>
        <p>التطبيق متكامل مع قاعدة بيانات Firebase وبيوفر تجربة مستخدم سلسة وسريعة.</p>
        <p style="margin-top: 20px; font-weight: bold;">Developed By Sara_1383</p>
    </div>
    </div>

    <div id="membersModal" class="modal">
      <div class="members-modal-content">
        <span class="close" id="closeMembersModal">&times;</span>
        <h3>أعضاء الغرفة</h3>
        <ul id="membersList" class="members-list"></ul>
        <div class="add-member-form">
          <input type="text" id="addMemberInput" placeholder="اسم المستخدم لإضافته">
          <button id="addMemberBtn">إضافة</button>
        </div>
      </div>
    </div>

    <div id="addRoomModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeAddRoomModal">&times;</span>
        <h3>انضم/أنشئ غرفة</h3>
        <div class="setting-group">
          <label for="roomNameInput">اسم الغرفة</label>
          <input type="text" id="roomNameInput" placeholder="أدخل اسم الغرفة">
        </div>
        <button id="joinRoomBtn" class="btn">انضم/أنشئ</button>
      </div>
    </div>

    <div id="addDMModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeAddDMModal">&times;</span>
        <h3>إضافة محادثة خاصة</h3>
        <div class="setting-group">
          <label for="dmUsernameInput">اسم المستخدم</label>
          <input type="text" id="dmUsernameInput" placeholder="أدخل اسم المستخدم">
        </div>
        <button id="startDMBtn" class="btn">بدء المحادثة</button>
      </div>
    </div>

    <div id="profileModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeProfileModal">&times;</span>
        <h3>معلومات المستخدم</h3>
        <div id="profileInfo">
          <p><strong>اسم المستخدم:</strong> <span id="profileUsername"></span></p>
          <p><strong>اسم العرض:</strong> <span id="profileDisplayName"></span></p>
          <p><strong>آخر ظهور:</strong> <span id="profileLastSeen"></span></p>
          <p><strong>الحالة:</strong> <span id="profileStatus"></span></p>
        </div>
      </div>
    </div>

    <div id="messageOptions" class="message-options">
      <button id="replyBtn">رد</button>
      <button id="copyBtn">نسخ</button>
      <button id="deleteBtn">حذف</button>
      <button id="reportBtn">إبلاغ</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBrDei5ZlZIJk0-aOBhJNBg_EZtvrTXSAg",
        authDomain: "chat-138313.firebaseapp.com",
        projectId: "chat-138313",
        storageBucket: "chat-1383.appspot.com",
        messagingSenderId: "135870025518",
        appId: "1:135870025518:web:153ce97539f371ee27f4bf"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const database = firebase.database();
      const storage = firebase.storage();

      // DOM Elements
      const loginSection = document.getElementById('loginSection');
      const chatSection = document.getElementById('chatSection');
      const formTitle = document.getElementById('formTitle');
      const formDescription = document.getElementById('formDescription');
      const mainBtn = document.getElementById('mainBtn');
      const toggleForm = document.getElementById('toggleForm');
      const message = document.getElementById('message');
      const displayNameGroup = document.getElementById('displayNameGroup');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const displayNameInput = document.getElementById('displayName');
      const meName = document.getElementById('meName');
      const roomList = document.getElementById('roomList');
      const addRoomBtn = document.getElementById('addRoomBtn');
      const addDMBtn = document.getElementById('addDMBtn');
      const roomInitialSelection = document.getElementById('roomInitialSelection');
      const chatRoomArea = document.getElementById('chatRoomArea');
      const currentRoomName = document.getElementById('currentRoomName');
      const messagesArea = document.getElementById('messagesArea');
      const textInput = document.getElementById('textInput');
      const sendBtn = document.getElementById('sendBtn');
      const fileBtn = document.getElementById('fileBtn');
      const fileInput = document.getElementById('fileInput');
      const voiceBtn = document.getElementById('voiceBtn');
      const cameraBtn = document.getElementById('cameraBtn');
      const cameraInput = document.getElementById('cameraInput');
      const recordingStatus = document.getElementById('recordingStatus');
      const userSettingsModal = document.getElementById('userSettingsModal');
      const closeUserSettingsModal = document.getElementById('closeUserSettingsModal');
      const userSettingsBtn = document.getElementById('userSettingsBtn');
      const roomSettingsModal = document.getElementById('roomSettingsModal');
      const closeRoomSettingsModal = document.getElementById('closeRoomSettingsModal');
      const roomSettingsBtn = document.getElementById('roomSettingsBtn');
      const aboutModal = document.getElementById('aboutModal');
      const closeAboutModal = document.getElementById('closeAboutModal');
      const aboutBtn = document.getElementById('aboutBtn');
      const membersModal = document.getElementById('membersModal');
      const closeMembersModal = document.getElementById('closeMembersModal');
      const membersBtn = document.getElementById('membersBtn');
      const membersList = document.getElementById('membersList');
      const addMemberInput = document.getElementById('addMemberInput');
      const addMemberBtn = document.getElementById('addMemberBtn');
      const addRoomModal = document.getElementById('addRoomModal');
      const closeAddRoomModal = document.getElementById('closeAddRoomModal');
      const roomNameInput = document.getElementById('roomNameInput');
      const joinRoomBtn = document.getElementById('joinRoomBtn');
      const addDMModal = document.getElementById('addDMModal');
      const closeAddDMModal = document.getElementById('closeAddDMModal');
      const dmUsernameInput = document.getElementById('dmUsernameInput');
      const startDMBtn = document.getElementById('startDMBtn');
      const profileModal = document.getElementById('profileModal');
      const closeProfileModal = document.getElementById('closeProfileModal');
      const profileUsername = document.getElementById('profileUsername');
      const profileDisplayName = document.getElementById('profileDisplayName');
      const profileLastSeen = document.getElementById('profileLastSeen');
      const profileStatus = document.getElementById('profileStatus');
      const messageOptions = document.getElementById('messageOptions');
      const replyBtn = document.getElementById('replyBtn');
      const copyBtn = document.getElementById('copyBtn');
      const deleteBtn = document.getElementById('deleteBtn');
      const reportBtn = document.getElementById('reportBtn');
      const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
      const sidebar = document.getElementById('sidebar');
      const autocompleteSuggestions = document.getElementById('autocomplete-suggestions');
      const gemiSuggestion = document.getElementById('gemi-suggestion');
      const replyIndicator = document.getElementById('replyIndicator');
      const replyText = document.getElementById('replyText');
      const cancelReply = document.getElementById('cancelReply');
      const usernameInputSettings = document.getElementById('usernameInput');
      const saveUsernameBtn = document.getElementById('saveUsernameBtn');
      const bioInput = document.getElementById('bioInput');
      const colorOptions = document.getElementById('colorOptions');
      const otherColorOptions = document.getElementById('otherColorOptions');
      const themeOptions = document.getElementById('themeOptions');
      const fontFamilySelect = document.getElementById('fontFamilySelect');
      const fontSizeSelect = document.getElementById('fontSizeSelect');
      const chatBackgroundInput = document.getElementById('chatBackgroundInput');
      const saveBackgroundBtn = document.getElementById('saveBackgroundBtn');
      const roomOwnerName = document.getElementById('roomOwnerName');
      const leaveRoomBtn = document.getElementById('leaveRoomBtn');
      const deleteRoomBtn = document.getElementById('deleteRoomBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const dmHeaderInfo = document.getElementById('dmHeaderInfo');

      // Global variables
      let isSignUp = false;
      let currentUser = null;
      let currentRoom = null;
      let currentRoomRef = null;
      let messagesRef = null;
      let mediaRecorder = null;
      let audioChunks = [];
      let isRecording = false;
      let selectedMessageId = null;
      let replyToMessageId = null;
      let replyToMessageContent = null;
      let lastDateDisplayed = null;
      let userSettings = {
        messageColor: '#0b5edd',
        otherUserColor: '#0b5edd',
        theme: 'dark',
        fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
        fontSize: '15px',
        chatBackground: '#1a1a2e'
      };
      let userStatus = {
        online: true,
        lastSeen: null,
        typing: false
      };
      let dmRooms = {};
      let allUsers = {};

      // Event Listeners
      mainBtn.addEventListener('click', handleAuth);
      toggleForm.addEventListener('click', toggleAuthForm);
      addRoomBtn.addEventListener('click', () => showModal(addRoomModal));
      addDMBtn.addEventListener('click', () => showModal(addDMModal));
      sendBtn.addEventListener('click', sendMessage);
      textInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      textInput.addEventListener('input', handleTyping);
      fileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileUpload);
      voiceBtn.addEventListener('click', toggleRecording);
      cameraBtn.addEventListener('click', () => cameraInput.click());
      cameraInput.addEventListener('change', handleImageUpload);
      userSettingsBtn.addEventListener('click', () => showModal(userSettingsModal));
      closeUserSettingsModal.addEventListener('click', () => hideModal(userSettingsModal));
      roomSettingsBtn.addEventListener('click', () => showModal(roomSettingsModal));
      closeRoomSettingsModal.addEventListener('click', () => hideModal(roomSettingsModal));
      aboutBtn.addEventListener('click', () => showModal(aboutModal));
      closeAboutModal.addEventListener('click', () => hideModal(aboutModal));
      membersBtn.addEventListener('click', () => showModal(membersModal));
      closeMembersModal.addEventListener('click', () => hideModal(membersModal));
      addMemberBtn.addEventListener('click', addMemberToRoom);
      joinRoomBtn.addEventListener('click', joinRoom);
      startDMBtn.addEventListener('click', addDMChat);
      closeAddRoomModal.addEventListener('click', () => hideModal(addRoomModal));
      closeAddDMModal.addEventListener('click', () => hideModal(addDMModal));
      closeProfileModal.addEventListener('click', () => hideModal(profileModal));
      document.addEventListener('click', (e) => {
        if (e.target !== messageOptions && !messageOptions.contains(e.target)) {
          messageOptions.style.display = 'none';
        }
      });
      replyBtn.addEventListener('click', handleReply);
      copyBtn.addEventListener('click', handleCopy);
      deleteBtn.addEventListener('click', handleDelete);
      reportBtn.addEventListener('click', handleReport);
      sidebarToggleBtn.addEventListener('click', toggleSidebar);
      gemiSuggestion.addEventListener('click', () => {
        textInput.value += '@gemini ';
        autocompleteSuggestions.style.display = 'none';
        textInput.focus();
      });
      cancelReply.addEventListener('click', cancelReplyMessage);
      saveUsernameBtn.addEventListener('click', saveUsername);
      saveBackgroundBtn.addEventListener('click', saveBackground);
      leaveRoomBtn.addEventListener('click', leaveRoom);
      deleteRoomBtn.addEventListener('click', deleteRoom);
      logoutBtn.addEventListener('click', logout);

      // Initialize settings
      initColorOptions();
      initThemeOptions();
      initFontSettings();

      // Load all users for autocomplete
      loadAllUsers();

      // Firebase Auth State Observer
      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
          loginSection.style.display = 'none';
          chatSection.style.display = 'flex';
          loadUserData();
          loadRooms();
          updateUserStatus(true);
        } else {
          currentUser = null;
          loginSection.style.display = 'block';
          chatSection.style.display = 'none';
        }
      });

      // Functions
      function toggleAuthForm() {
        isSignUp = !isSignUp;
        if (isSignUp) {
          formTitle.textContent = 'إنشاء حساب';
          formDescription.textContent = 'أنشئ حساب جديد للبدء في استخدام التطبيق';
          mainBtn.textContent = 'إنشاء حساب';
          toggleForm.textContent = 'لديك حساب بالفعل؟ تسجيل الدخول';
          displayNameGroup.style.display = 'block';
        } else {
          formTitle.textContent = 'تسجيل الدخول';
          formDescription.textContent = 'لا يمكنك استخدام التطبيق بدون تسجيل الدخول أو إنشاء حساب جديد.';
          mainBtn.textContent = 'تسجيل الدخول';
          toggleForm.textContent = 'لا تملك حسابًا؟ إنشاء حساب';
          displayNameGroup.style.display = 'none';
        }
        message.style.display = 'none';
        usernameInput.value = '';
        passwordInput.value = '';
        displayNameInput.value = '';
      }

      function handleAuth() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        const displayName = displayNameInput.value.trim();

        if (!username || !password) {
          showMessage('يرجى ملء جميع الحقول المطلوبة');
          return;
        }

        if (isSignUp && !displayName) {
          showMessage('يرجى إدخال اسم العرض');
          return;
        }

        if (isSignUp) {
          // Check if username already exists
          database.ref('usernames').child(username).once('value')
            .then((snapshot) => {
              if (snapshot.exists()) {
                showMessage('اسم المستخدم موجود بالفعل، يرجى اختيار اسم آخر');
                return;
              }
              
              // Create user with email (using username as email)
              const email = `${username}@chat.com`;
              auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                  const user = userCredential.user;
                  
                  // Save username to prevent duplicates
                  database.ref('usernames').child(username).set(user.uid);
                  
                  // Update profile with display name
                  return user.updateProfile({
                    displayName: displayName
                  }).then(() => {
                    // Create user profile in database
                    return database.ref('users/' + user.uid).set({
                      username: username,
                      displayName: displayName,
                      email: email,
                      createdAt: firebase.database.ServerValue.TIMESTAMP,
                      lastSeen: firebase.database.ServerValue.TIMESTAMP,
                      isOnline: true
                    });
                  });
                })
                .then(() => {
                  showMessage('تم إنشاء الحساب بنجاح!', 'success');
                })
                .catch((error) => {
                  showMessage(error.message);
                });
            })
            .catch((error) => {
              showMessage('حدث خطأ: ' + error.message);
            });
        } else {
          // Sign in - find user by username
          database.ref('usernames').child(username).once('value')
            .then((snapshot) => {
              if (!snapshot.exists()) {
                showMessage('اسم المستخدم غير موجود');
                return;
              }
              
              const userId = snapshot.val();
              // Get user email from database
              database.ref('users/' + userId).once('value')
                .then((userSnapshot) => {
                  const userData = userSnapshot.val();
                  if (!userData) {
                    showMessage('خطأ في بيانات المستخدم');
                    return;
                  }
                  
                  // Sign in with email
                  auth.signInWithEmailAndPassword(userData.email, password)
                    .then(() => {
                      showMessage('تم تسجيل الدخول بنجاح!', 'success');
                    })
                    .catch((error) => {
                      showMessage('كلمة المرور غير صحيحة');
                    });
                })
                .catch((error) => {
                  showMessage('حدث خطأ: ' + error.message);
                });
            })
            .catch((error) => {
              showMessage('حدث خطأ: ' + error.message);
            });
        }
      }

      function showMessage(msg, type = 'error') {
        message.textContent = msg;
        message.style.display = 'block';
        if (type === 'success') {
          message.classList.add('success-message');
        } else {
          message.classList.remove('success-message');
        }
      }

      function loadAllUsers() {
        database.ref('users').on('value', (snapshot) => {
          allUsers = snapshot.val() || {};
        });
      }

      function loadUserData() {
        database.ref('users/' + currentUser.uid).once('value')
          .then((snapshot) => {
            const userData = snapshot.val();
            if (userData) {
              meName.textContent = userData.displayName || userData.username;
              usernameInputSettings.value = userData.displayName || userData.username;
              
              // Load user settings
              loadUserSettings();
            }
          });
      }

      function loadUserSettings() {
        database.ref('userSettings/' + currentUser.uid).once('value')
          .then((snapshot) => {
            if (snapshot.exists()) {
              userSettings = { ...userSettings, ...snapshot.val() };
              applyUserSettings();
            }
          });
      }

      function showModal(modal) {
        modal.style.display = 'block';
      }

      function hideModal(modal) {
        modal.style.display = 'none';
      }

      function loadRooms() {
        // Load public rooms
        database.ref('rooms').on('value', (snapshot) => {
          roomList.innerHTML = '';
          const rooms = snapshot.val();
          
          if (rooms) {
            Object.keys(rooms).forEach(roomId => {
              if (rooms[roomId].type !== 'dm') {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.textContent = rooms[roomId].name;
                button.addEventListener('click', () => joinRoomById(roomId));
                
                const leaveBtn = document.createElement('button');
                leaveBtn.className = 'leave-room-btn';
                leaveBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i>';
                leaveBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  leaveRoomById(roomId);
                });
                
                li.appendChild(button);
                li.appendChild(leaveBtn);
                roomList.appendChild(li);
              }
            });
          }
        });

        // Load DM rooms for current user
        loadDMRooms();
      }

      function loadDMRooms() {
        database.ref('users/' + currentUser.uid + '/dmRooms').on('value', (snapshot) => {
          const dmRoomsData = snapshot.val();
          
          if (dmRoomsData) {
            Object.keys(dmRoomsData).forEach(dmRoomId => {
              if (!document.getElementById(`dm-${dmRoomId}`)) {
                addDMRoomToSidebar(dmRoomId, dmRoomsData[dmRoomId]);
              }
            });
          }
        });
      }

      function addDMRoomToSidebar(roomId, roomData) {
        const li = document.createElement('li');
        li.id = `dm-${roomId}`;
        
        const button = document.createElement('button');
        button.textContent = roomData.name;
        button.addEventListener('click', () => joinRoomById(roomId));
        
        const leaveBtn = document.createElement('button');
        leaveBtn.className = 'leave-room-btn';
        leaveBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i>';
        leaveBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          leaveDMRoom(roomId);
        });
        
        li.appendChild(button);
        li.appendChild(leaveBtn);
        roomList.appendChild(li);
      }

      function joinRoom() {
        const roomName = roomNameInput.value.trim();
        if (!roomName) {
          alert('يرجى إدخال اسم الغرفة');
          return;
        }

        // Check if room exists
        database.ref('rooms').orderByChild('name').equalTo(roomName).once('value')
          .then((snapshot) => {
            if (snapshot.exists()) {
              // Join existing room
              const roomData = snapshot.val();
              const roomId = Object.keys(roomData)[0];
              joinRoomById(roomId);
            } else {
              // Create new room
              const newRoomRef = database.ref('rooms').push();
              newRoomRef.set({
                name: roomName,
                owner: currentUser.uid,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                type: 'public'
              }).then(() => {
                joinRoomById(newRoomRef.key);
              });
            }
            hideModal(addRoomModal);
            roomNameInput.value = '';
          });
      }

      function joinRoomById(roomId) {
        if (currentRoomRef) {
          currentRoomRef.off();
        }
        
        currentRoom = roomId;
        currentRoomRef = database.ref('rooms/' + roomId);
        
        // Get room info
        currentRoomRef.once('value').then((snapshot) => {
          const roomData = snapshot.val();
          currentRoomName.textContent = roomData.name;
          roomOwnerName.textContent = roomData.owner === currentUser.uid ? 'أنت' : (roomData.ownerName || 'مستخدم');
          
          // Show delete button only for room owner
          if (roomData.owner === currentUser.uid) {
            deleteRoomBtn.style.display = 'block';
          } else {
            deleteRoomBtn.style.display = 'none';
          }
          
          // Hide DM info for public rooms
          dmHeaderInfo.style.display = 'none';
        });
        
        // Load messages
        messagesRef = database.ref('messages/' + roomId);
        messagesRef.off(); // Remove previous listeners
        
        messagesRef.orderByChild('timestamp').on('child_added', (snapshot) => {
          const message = snapshot.val();
          displayMessage(snapshot.key, message);
        });
        
        // Update UI
        roomInitialSelection.style.display = 'none';
        chatRoomArea.style.display = 'flex';
        
        // Mark room as active in sidebar
        document.querySelectorAll('#roomList button').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Add user to room members if not already a member
        database.ref('roomMembers/' + roomId + '/' + currentUser.uid).set({
          joinedAt: firebase.database.ServerValue.TIMESTAMP,
          displayName: currentUser.displayName
        });
        
        // Update user status
        updateUserStatus(true);
      }

      function addDMChat() {
        const username = dmUsernameInput.value.trim();
        if (!username) {
          alert('يرجى إدخال اسم المستخدم');
          return;
        }

        // Find user by username
        let userFound = false;
        let userId = null;
        let userDisplayName = null;
        
        for (const uid in allUsers) {
          if (allUsers[uid].username === username) {
            userFound = true;
            userId = uid;
            userDisplayName = allUsers[uid].displayName;
            break;
          }
        }
        
        if (!userFound) {
          alert('اسم المستخدم غير موجود');
          return;
        }
        
        if (userId === currentUser.uid) {
          alert('لا يمكنك إنشاء محادثة مع نفسك');
          return;
        }
        
        // Create DM room ID (combination of both user IDs)
        const dmRoomId = [currentUser.uid, userId].sort().join('_');
        
        // Check if DM room already exists
        database.ref('rooms/' + dmRoomId).once('value')
          .then((roomSnapshot) => {
            if (!roomSnapshot.exists()) {
              // Create new DM room
              database.ref('rooms/' + dmRoomId).set({
                name: `${currentUser.displayName} و ${userDisplayName}`,
                type: 'dm',
                participants: {
                  [currentUser.uid]: true,
                  [userId]: true
                },
                createdAt: firebase.database.ServerValue.TIMESTAMP
              });
            }
            
            // Add DM room to user's DM rooms list
            database.ref('users/' + currentUser.uid + '/dmRooms/' + dmRoomId).set({
              name: userDisplayName,
              userId: userId
            });
            
            database.ref('users/' + userId + '/dmRooms/' + dmRoomId).set({
              name: currentUser.displayName,
              userId: currentUser.uid
            });
            
            hideModal(addDMModal);
            dmUsernameInput.value = '';
            joinRoomById(dmRoomId);
            
            // Show DM info
            dmHeaderInfo.style.display = 'block';
            updateDMStatus(userId);
          });
      }

      function updateDMStatus(userId) {
        if (!userId) return;
        
        database.ref('users/' + userId).on('value', (snapshot) => {
          const userData = snapshot.val();
          if (userData) {
            if (userData.isOnline) {
              dmHeaderInfo.innerHTML = '<span class="online-status"></span> متصل الآن';
            } else {
              const lastSeen = new Date(userData.lastSeen);
              const now = new Date();
              const diffMs = now - lastSeen;
              const diffMins = Math.floor(diffMs / 60000);
              
              if (diffMins < 1) {
                dmHeaderInfo.textContent = 'كان متصلًا منذ لحظات';
              } else if (diffMins < 60) {
                dmHeaderInfo.textContent = `كان متصلًا منذ ${diffMins} دقيقة`;
              } else if (diffMins < 1440) {
                const diffHours = Math.floor(diffMins / 60);
                dmHeaderInfo.textContent = `كان متصلًا منذ ${diffHours} ساعة`;
              } else {
                const diffDays = Math.floor(diffMins / 1440);
                dmHeaderInfo.textContent = `كان متصلًا منذ ${diffDays} يوم`;
              }
            }
          }
        });
      }

      function leaveRoomById(roomId) {
        if (currentRoom === roomId) {
          leaveRoom();
        } else {
          database.ref('roomMembers/' + roomId + '/' + currentUser.uid).remove();
          // Remove from sidebar
          const roomElement = document.querySelector(`li button[data-room="${roomId}"]`);
          if (roomElement) {
            roomElement.parentElement.remove();
          }
        }
      }

      function leaveDMRoom(roomId) {
        database.ref('users/' + currentUser.uid + '/dmRooms/' + roomId).remove();
        
        // Remove from sidebar
        const dmRoomElement = document.getElementById(`dm-${roomId}`);
        if (dmRoomElement) {
          dmRoomElement.remove();
        }
        
        if (currentRoom === roomId) {
          leaveRoom();
        }
      }

      function displayMessage(messageId, message) {
        // Check if we need to display date separator
        const messageDate = new Date(message.timestamp);
        const messageDateStr = messageDate.toDateString();
        
        if (messageDateStr !== lastDateDisplayed) {
          const dateSeparator = document.createElement('div');
          dateSeparator.className = 'date-separator';
          dateSeparator.innerHTML = `<span>${formatDate(messageDate)}</span>`;
          messagesArea.appendChild(dateSeparator);
          lastDateDisplayed = messageDateStr;
        }
        
        const messageWrapper = document.createElement('div');
        messageWrapper.id = `message-${messageId}`;
        
        if (message.senderId === currentUser.uid) {
          messageWrapper.className = 'message-wrapper me';
        } else if (message.senderId === 'gemini') {
          messageWrapper.className = 'message-wrapper gemini';
        } else {
          messageWrapper.className = 'message-wrapper other';
        }
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        // Add reply indicator if this is a reply
        if (message.replyTo) {
          const replyTo = document.createElement('span');
          replyTo.className = 'reply-to';
          replyTo.textContent = `رد على: ${message.replyToContent || 'رسالة'}`;
          messageContent.appendChild(replyTo);
        }
        
        const messageMeta = document.createElement('div');
        messageMeta.className = 'message-meta';
        
        const senderName = document.createElement('span');
        senderName.className = 'sender-name';
        senderName.textContent = message.senderName || 'مستخدم';
        senderName.style.cursor = 'pointer';
        senderName.addEventListener('click', () => showUserProfile(message.senderId));
        
        const timestamp = document.createElement('span');
        timestamp.className = 'timestamp';
        timestamp.textContent = formatTime(message.timestamp);
        
        messageMeta.appendChild(senderName);
        messageMeta.appendChild(timestamp);
        
        const messageText = document.createElement('div');
        messageText.className = 'message-text';
        
        if (message.type === 'text') {
          messageText.textContent = message.text;
        } else if (message.type === 'image') {
          const img = document.createElement('img');
          img.src = message.url;
          img.alt = 'صورة مرسلة';
          img.style.maxWidth = '100%';
          img.style.borderRadius = '8px';
          messageText.appendChild(img);
        } else if (message.type === 'file') {
          const fileLink = document.createElement('a');
          fileLink.href = message.url;
          fileLink.textContent = message.fileName || 'ملف';
          fileLink.target = '_blank';
          messageText.appendChild(fileLink);
        } else if (message.type === 'audio') {
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = message.url;
          messageText.appendChild(audio);
        }
        
        messageContent.appendChild(messageMeta);
        messageContent.appendChild(messageText);
        
        // Add read receipts for user's messages
        if (message.senderId === currentUser.uid) {
          const readReceipts = document.createElement('div');
          readReceipts.className = 'read-receipts';
          readReceipts.id = `receipts-${messageId}`;
          
          // Initially show single check (sent)
          readReceipts.innerHTML = '<i class="fas fa-check"></i>';
          
          messageContent.appendChild(readReceipts);
          
          // Update read receipts
          updateReadReceipts(messageId, message.roomId);
        }
        
        // Add reply button for other users' messages
        if (message.senderId !== currentUser.uid) {
          const replyButton = document.createElement('button');
          replyButton.className = 'reply-btn';
          replyButton.innerHTML = '<i class="fas fa-reply"></i> رد';
          replyButton.addEventListener('click', () => {
            replyToMessageId = messageId;
            replyToMessageContent = message.text || 'رسالة';
            replyText.textContent = `رد على: ${replyToMessageContent.substring(0, 30)}${replyToMessageContent.length > 30 ? '...' : ''}`;
            replyIndicator.style.display = 'flex';
            textInput.focus();
          });
          messageContent.appendChild(replyButton);
        }
        
        messageWrapper.appendChild(messageContent);
        messagesArea.appendChild(messageWrapper);
        
        // Scroll to bottom
        messagesArea.scrollTop = messagesArea.scrollHeight;
        
        // Add context menu for messages
        messageWrapper.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          selectedMessageId = messageId;
          
          // Position the menu
          messageOptions.style.display = 'block';
          messageOptions.style.left = `${e.pageX}px`;
          messageOptions.style.top = `${e.pageY}px`;
          
          // Show delete button only for user's own messages
          if (message.senderId === currentUser.uid) {
            deleteBtn.style.display = 'block';
          } else {
            deleteBtn.style.display = 'none';
          }
        });
      }

      function showUserProfile(userId) {
        database.ref('users/' + userId).once('value')
          .then((snapshot) => {
            const userData = snapshot.val();
            if (userData) {
              profileUsername.textContent = userData.username;
              profileDisplayName.textContent = userData.displayName;
              
              if (userData.isOnline) {
                profileStatus.innerHTML = '<span class="online-status"></span> متصل الآن';
                profileLastSeen.textContent = 'متصل الآن';
              } else {
                profileStatus.textContent = 'غير متصل';
                const lastSeen = new Date(userData.lastSeen);
                profileLastSeen.textContent = lastSeen.toLocaleString('ar-EG');
              }
              
              showModal(profileModal);
            }
          })
          .catch((error) => {
            console.error('Error getting user profile:', error);
          });
      }

      function updateReadReceipts(messageId, roomId) {
        // Get room members
        database.ref('roomMembers/' + roomId).once('value')
          .then((snapshot) => {
            const members = snapshot.val();
            const memberCount = Object.keys(members).length;
            
            // Get message reads
            database.ref('messageReads/' + messageId).on('value', (readSnapshot) => {
              const reads = readSnapshot.val();
              let readCount = 0;
              
              if (reads) {
                readCount = Object.keys(reads).length;
              }
              
              const readReceipts = document.getElementById(`receipts-${messageId}`);
              if (readReceipts) {
                if (readCount >= memberCount) {
                  // All members have read the message
                  readReceipts.innerHTML = '<i class="fas fa-check seen"></i><i class="fas fa-check seen"></i>';
                } else if (readCount > 0) {
                  // Some members have read the message
                  readReceipts.innerHTML = '<i class="fas fa-check"></i><i class="fas fa-check seen"></i>';
                } else {
                  // No one has read the message yet
                  readReceipts.innerHTML = '<i class="fas fa-check"></i>';
                }
              }
            });
          });
      }

      function sendMessage() {
        const text = textInput.value.trim();
        if (!text && !replyToMessageId) return;
        
        const messageData = {
          text: text,
          senderId: currentUser.uid,
          senderName: currentUser.displayName,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          roomId: currentRoom,
          type: 'text'
        };
        
        // Add reply data if replying to a message
        if (replyToMessageId) {
          messageData.replyTo = replyToMessageId;
          messageData.replyToContent = replyToMessageContent;
        }
        
        // Push message to database
        messagesRef.push(messageData)
          .then(() => {
            textInput.value = '';
            cancelReplyMessage();
            
            // Reset typing status
            userStatus.typing = false;
            updateUserStatus(true);
          });
      }

      function handleTyping() {
        if (!userStatus.typing) {
          userStatus.typing = true;
          updateUserStatus(true);
          
          // Set timeout to reset typing status after 3 seconds
          setTimeout(() => {
            userStatus.typing = false;
            updateUserStatus(true);
          }, 3000);
        }
      }

      function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Upload file to Firebase Storage
        const storageRef = storage.ref();
        const fileRef = storageRef.child(`files/${currentUser.uid}/${Date.now()}_${file.name}`);
        
        fileRef.put(file).then((snapshot) => {
          snapshot.ref.getDownloadURL().then((url) => {
            // Send message with file
            const messageData = {
              type: file.type.startsWith('image/') ? 'image' : 'file',
              url: url,
              fileName: file.name,
              senderId: currentUser.uid,
              senderName: currentUser.displayName,
              timestamp: firebase.database.ServerValue.TIMESTAMP,
              roomId: currentRoom
            };
            
            messagesRef.push(messageData);
          });
        });
        
        // Reset file input
        fileInput.value = '';
      }

      function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Upload image to Firebase Storage
        const storageRef = storage.ref();
        const imageRef = storageRef.child(`images/${currentUser.uid}/${Date.now()}_${file.name}`);
        
        imageRef.put(file).then((snapshot) => {
          snapshot.ref.getDownloadURL().then((url) => {
            // Send message with image
            const messageData = {
              type: 'image',
              url: url,
              senderId: currentUser.uid,
              senderName: currentUser.displayName,
              timestamp: firebase.database.ServerValue.TIMESTAMP,
              roomId: currentRoom
            };
            
            messagesRef.push(messageData);
          });
        });
        
        // Reset camera input
        cameraInput.value = '';
      }

      function toggleRecording() {
        if (!isRecording) {
          startRecording();
        } else {
          stopRecording();
        }
      }

      function startRecording() {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then((stream) => {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (e) => {
              audioChunks.push(e.data);
            };
            
            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
              
              // Upload audio to Firebase Storage
              const storageRef = storage.ref();
              const audioRef = storageRef.child(`audio/${currentUser.uid}/${Date.now()}.wav`);
              
              audioRef.put(audioBlob).then((snapshot) => {
                snapshot.ref.getDownloadURL().then((url) => {
                  // Send message with audio
                  const messageData = {
                    type: 'audio',
                    url: url,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    roomId: currentRoom
                  };
                  
                  messagesRef.push(messageData);
                });
              });
              
              // Stop all tracks
              stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            isRecording = true;
            recordingStatus.style.display = 'inline';
            voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
          })
          .catch((error) => {
            console.error('Error accessing microphone:', error);
            alert('تعذر الوصول إلى الميكروفون');
          });
      }

      function stopRecording() {
        if (mediaRecorder && isRecording) {
          mediaRecorder.stop();
          isRecording = false;
          recordingStatus.style.display = 'none';
          voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        }
      }

      function handleReply() {
        if (!selectedMessageId) return;
        
        const messageElement = document.getElementById(`message-${selectedMessageId}`);
        if (messageElement) {
          const messageText = messageElement.querySelector('.message-text').textContent;
          replyToMessageId = selectedMessageId;
          replyToMessageContent = messageText;
          replyText.textContent = `رد على: ${replyToMessageContent.substring(0, 30)}${replyToMessageContent.length > 30 ? '...' : ''}`;
          replyIndicator.style.display = 'flex';
          textInput.focus();
        }
        
        messageOptions.style.display = 'none';
      }

      function handleCopy() {
        if (!selectedMessageId) return;
        
        const messageElement = document.getElementById(`message-${selectedMessageId}`);
        if (messageElement) {
          const messageText = messageElement.querySelector('.message-text').textContent;
          navigator.clipboard.writeText(messageText)
            .then(() => {
              alert('تم نسخ النص');
            })
            .catch(() => {
              alert('فشل نسخ النص');
            });
        }
        
        messageOptions.style.display = 'none';
      }

      function handleDelete() {
        if (!selectedMessageId) return;
        
        if (confirm('هل أنت متأكد من حذف هذه الرسالة؟')) {
          messagesRef.child(selectedMessageId).remove()
            .then(() => {
              const messageElement = document.getElementById(`message-${selectedMessageId}`);
              if (messageElement) {
                messageElement.remove();
              }
            })
            .catch((error) => {
              alert('فشل حذف الرسالة: ' + error.message);
            });
        }
        
        messageOptions.style.display = 'none';
      }

      function handleReport() {
        if (!selectedMessageId) return;
        
        alert('تم الإبلاغ عن الرسالة للمشرفين');
        messageOptions.style.display = 'none';
      }

      function cancelReplyMessage() {
        replyToMessageId = null;
        replyToMessageContent = null;
        replyIndicator.style.display = 'none';
      }

      function toggleSidebar() {
        sidebar.classList.toggle('active');
        sidebarToggleBtn.classList.toggle('active');
      }

      function formatDate(date) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('ar-EG', options);
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
      }

      function addMemberToRoom() {
        const username = addMemberInput.value.trim();
        if (!username) {
          alert('يرجى إدخال اسم المستخدم');
          return;
        }

        // Find user by username
        let userFound = false;
        let userId = null;
        
        for (const uid in allUsers) {
          if (allUsers[uid].username === username) {
            userFound = true;
            userId = uid;
            break;
          }
        }
        
        if (!userFound) {
          alert('اسم المستخدم غير موجود');
          return;
        }
        
        // Add user to room members
        database.ref('roomMembers/' + currentRoom + '/' + userId).set({
          joinedAt: firebase.database.ServerValue.TIMESTAMP,
          displayName: allUsers[userId].displayName
        });
        
        addMemberInput.value = '';
        alert('تم إضافة المستخدم إلى الغرفة');
      }

      function saveUsername() {
        const newUsername = usernameInputSettings.value.trim();
        if (!newUsername) {
          alert('يرجى إدخال اسم جديد');
          return;
        }
        
        // Update in Firebase Auth
        currentUser.updateProfile({
          displayName: newUsername
        }).then(() => {
          // Update in database
          database.ref('users/' + currentUser.uid).update({
            displayName: newUsername
          }).then(() => {
            meName.textContent = newUsername;
            alert('تم تحديث الاسم بنجاح');
          });
        }).catch((error) => {
          alert('فشل تحديث الاسم: ' + error.message);
        });
      }

      function saveBackground() {
        const background = chatBackgroundInput.value.trim();
        if (!background) return;
        
        // Check if it's a URL or color code
        if (background.startsWith('http') || background.startsWith('#')) {
          userSettings.chatBackground = background;
          
          // Save to database
          database.ref('userSettings/' + currentUser.uid).update({
            chatBackground: background
          }).then(() => {
            applyUserSettings();
            alert('تم تحديث الخلفية بنجاح');
          });
        } else {
          alert('يرجى إدخال رابط صورة صالح أو كود لون');
        }
      }

      function initColorOptions() {
        // User message color options
        colorOptions.querySelectorAll('.color-option').forEach(option => {
          option.addEventListener('click', () => {
            colorOptions.querySelectorAll('.color-option').forEach(opt => {
              opt.classList.remove('selected');
            });
            option.classList.add('selected');
            
            userSettings.messageColor = option.getAttribute('data-color');
            database.ref('userSettings/' + currentUser.uid).update({
              messageColor: userSettings.messageColor
            }).then(() => {
              applyUserSettings();
            });
          });
          
          // Select current color
          if (option.getAttribute('data-color') === userSettings.messageColor) {
            option.classList.add('selected');
          }
        });
        
        // Other user message color options
        otherColorOptions.querySelectorAll('.color-option').forEach(option => {
          option.addEventListener('click', () => {
            otherColorOptions.querySelectorAll('.color-option').forEach(opt => {
              opt.classList.remove('selected');
            });
            option.classList.add('selected');
            
            userSettings.otherUserColor = option.getAttribute('data-color');
            database.ref('userSettings/' + currentUser.uid).update({
              otherUserColor: userSettings.otherUserColor
            }).then(() => {
              applyUserSettings();
            });
          });
          
          // Select current color
          if (option.getAttribute('data-color') === userSettings.otherUserColor) {
            option.classList.add('selected');
          }
        });
      }

      function initThemeOptions() {
        themeOptions.querySelectorAll('button').forEach(button => {
          button.addEventListener('click', () => {
            themeOptions.querySelectorAll('button').forEach(btn => {
              btn.classList.remove('selected');
            });
            button.classList.add('selected');
            
            userSettings.theme = button.getAttribute('data-theme');
            database.ref('userSettings/' + currentUser.uid).update({
              theme: userSettings.theme
            }).then(() => {
              applyUserSettings();
            });
          });
          
          // Select current theme
          if (button.getAttribute('data-theme') === userSettings.theme) {
            button.classList.add('selected');
          }
        });
      }

      function initFontSettings() {
        fontFamilySelect.value = userSettings.fontFamily;
        fontSizeSelect.value = userSettings.fontSize;
        
        fontFamilySelect.addEventListener('change', () => {
          userSettings.fontFamily = fontFamilySelect.value;
          database.ref('userSettings/' + currentUser.uid).update({
            fontFamily: userSettings.fontFamily
          }).then(() => {
            applyUserSettings();
          });
        });
        
        fontSizeSelect.addEventListener('change', () => {
          userSettings.fontSize = fontSizeSelect.value;
          database.ref('userSettings/' + currentUser.uid).update({
            fontSize: userSettings.fontSize
          }).then(() => {
            applyUserSettings();
          });
        });
      }

      function applyUserSettings() {
        // Apply theme
        if (userSettings.theme === 'light') {
          document.body.classList.add('light-theme');
        } else {
          document.body.classList.remove('light-theme');
        }
        
        // Apply font settings
        document.documentElement.style.setProperty('--font-family', userSettings.fontFamily);
        document.documentElement.style.setProperty('--font-size', userSettings.fontSize);
        
        // Apply message colors
        document.documentElement.style.setProperty('--my-message-bg', userSettings.messageColor);
        document.documentElement.style.setProperty('--other-user-color', userSettings.otherUserColor);
        
        // Apply chat background
        if (userSettings.chatBackground.startsWith('http')) {
          document.documentElement.style.setProperty('--chat-bg-image', `url(${userSettings.chatBackground})`);
          document.documentElement.style.setProperty('--chat-bg-color', 'transparent');
        } else {
          document.documentElement.style.setProperty('--chat-bg-image', 'none');
          document.documentElement.style.setProperty('--chat-bg-color', userSettings.chatBackground);
        }
      }

      function updateUserStatus(online) {
        if (!currentUser) return;
        
        userStatus.online = online;
        userStatus.lastSeen = online ? null : Date.now();
        
        // Update in database
        database.ref('users/' + currentUser.uid).update({
          isOnline: userStatus.online,
          lastSeen: userStatus.lastSeen,
          typing: userStatus.typing
        });
      }

      function leaveRoom() {
        if (currentRoom) {
          // Remove user from room members
          database.ref('roomMembers/' + currentRoom + '/' + currentUser.uid).remove();
          
          // Reset current room
          currentRoom = null;
          currentRoomRef = null;
          messagesRef = null;
          
          // Update UI
          roomInitialSelection.style.display = 'flex';
          chatRoomArea.style.display = 'none';
          messagesArea.innerHTML = '';
          lastDateDisplayed = null;
        }
      }

      function deleteRoom() {
        if (currentRoom && confirm('هل أنت متأكد من حذف هذه الغرفة؟ سيتم حذف جميع الرسائل أيضًا.')) {
          // Delete room and all messages
          database.ref('rooms/' + currentRoom).remove();
          database.ref('messages/' + currentRoom).remove();
          database.ref('roomMembers/' + currentRoom).remove();
          
          // Leave room
          leaveRoom();
        }
      }

      function logout() {
        updateUserStatus(false);
        auth.signOut();
      }

      // Handle window close/tab close
      window.addEventListener('beforeunload', () => {
        updateUserStatus(false);
      });

      // Auto-resize textarea
      textInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        
        // Limit height to 150px
        if (this.scrollHeight > 150) {
          this.style.overflowY = 'auto';
        } else {
          this.style.overflowY = 'hidden';
        }
      });

      // Handle autocomplete
      textInput.addEventListener('input', function() {
        if (this.value.includes('@')) {
          autocompleteSuggestions.style.display = 'block';
        } else {
          autocompleteSuggestions.style.display = 'none';
        }
      });

      // Hide autocomplete when clicking outside
      document.addEventListener('click', (e) => {
        if (e.target !== textInput && !autocompleteSuggestions.contains(e.target)) {
          autocompleteSuggestions.style.display = 'none';
        }
      });
    </script>
  </body>
</html>
