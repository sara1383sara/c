<!doctype html>
<html lang="ar">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat - 1383</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
      :root {
        --bg-dark: #1a1a2e;
        --bg-light: #2c2c44;
        --text-color: #e0e0e0;
        --border-color: #44445c;
        --input-bg: #3c3c54;
        --other-message-bg: #f0f2f5;
        --other-message-text-color: #333;
        --accent-color: #0b5edd;
        --hover-color: #0d6efd;
        --sidebar-width: 250px;
        --chat-bg-image: none;
        --chat-bg-color: var(--bg-dark);
        --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        --font-size: 15px;
        --my-message-bg: var(--accent-color);
        --my-message-text-color: #fff;
        --system-message-bg: #444; /* Added for system messages */
        --system-message-text-color: #fff; /* Added for system messages */
      }
      .light-theme {
        --bg-dark: #f0f2f5;
        --bg-light: #ffffff;
        --text-color: #333333;
        --border-color: #e0e0e0;
        --input-bg: #f6f7fb;
        --other-message-bg: #f6f7fb;
        --other-message-text-color: #333;
        --accent-color: #0b5edd;
        --hover-color: #0d6efd;
        --my-message-bg: var(--accent-color);
        --my-message-text-color: #fff;
      }
      body {
        font-family: var(--font-family);
        font-size: var(--font-size);
        background: var(--bg-dark);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        transition: background-color 0.3s ease;
      }
      .app {
        display: flex;
        width: 100%;
        height: 100%;
        position: relative;
      }
      .sidebar-toggle-btn {
        position: fixed;
        top: 15px;
        left: 15px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--accent-color);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 18px;
        z-index: 100;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: left 0.3s ease, transform 0.3s ease;
      }
      .sidebar-toggle-btn.active {
          left: calc(var(--sidebar-width) + 15px);
          transform: rotate(180deg);
      }
      .sidebar {
        width: var(--sidebar-width);
        background: var(--bg-light);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 15px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        position: fixed;
        height: 100%;
        left: 0;
        top: 0;
        z-index: 99;
      }
      .sidebar.active {
        transform: translateX(0);
      }
      @media (min-width: 768px) {
        .sidebar {
          transform: translateX(0);
          position: relative;
        }
        .sidebar-toggle-btn {
          display: none;
        }
        .app {
          flex-direction: row;
        }
      }
      @media (max-width: 767px) {
        .app {
            flex-direction: column;
        }
        .chat-main {
            width: 100%;
            height: 100%;
        }
      }
      .sidebar h3 {
        color: var(--text-color);
        margin-top: 0;
        margin-bottom: 20px;
        text-align: center;
      }
      .user-info {
        font-size: 14px;
        margin-bottom: 20px;
        color: var(--text-color);
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
      }
      .room-list {
        flex-grow: 1;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .room-list li {
        margin-bottom: 8px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: none;
        border: 1px solid transparent;
        border-radius: 5px;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }
      .room-list li:hover {
        background-color: var(--input-bg);
      }
      .room-list button {
        background: none;
        border: none;
        color: var(--text-color);
        padding: 10px 15px;
        text-align: right;
        flex-grow: 1;
        cursor: pointer;
      }
      .room-list button.active {
        background-color: var(--accent-color);
        color: white;
      }
      .leave-room-btn, .games-menu-btn {
          background: none;
          border: none;
          cursor: pointer;
          font-size: 14px;
          padding: 10px;
          display: block;
          margin-left: 5px;
      }
      .leave-room-btn {
          color: #e74c3c;
      }
      .games-menu-btn {
          color: #2ecc71;
      }
      .room-list button.active + .games-menu-btn,
      .room-list button.active + .games-menu-btn + .leave-room-btn {
          color: white;
      }
      .add-room-btn {
        width: 100%;
        padding: 12px;
        margin-top: 20px;
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        transition: background-color 0.2s ease;
      }
      .add-room-btn:hover {
        background-color: var(--hover-color);
      }
      .chat-main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background: var(--chat-bg-color);
        background-image: var(--chat-bg-image);
        background-size: cover;
        background-position: center;
      }
      .chat-header {
        background: var(--bg-light);
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .chat-header h2 {
        margin: 0;
        font-size: 18px;
        color: var(--text-color);
      }
      .header-actions {
          display: flex;
          gap: 10px;
      }
      .settings-btn {
          background: none;
          border: none;
          color: var(--text-color);
          font-size: 20px;
          cursor: pointer;
          transition: color 0.2s ease;
      }
      .settings-btn:hover {
          color: var(--accent-color);
      }
      .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 15px 20px;
        display: flex;
        flex-direction: column;
      }
      .message-wrapper {
        display: flex;
        margin-bottom: 15px;
      }
      .message-wrapper.me {
        justify-content: flex-end;
      }
      .message-wrapper.other {
        justify-content: flex-start;
      }
      .message-wrapper.system { /* Added system message style */
          justify-content: center;
          text-align: center;
      }
      .message-wrapper.gemini {
          justify-content: flex-start;
          text-align: right;
      }
      .message-content {
        max-width: 70%;
        padding: 12px 15px;
        border-radius: 18px;
        line-height: 1.4;
        position: relative;
        word-wrap: break-word;
      }
      .message-wrapper.me .message-content {
        background: var(--my-message-bg);
        color: var(--my-message-text-color);
        border-bottom-right-radius: 4px;
      }
      .message-wrapper.other .message-content {
        background: var(--other-message-bg);
        color: var(--other-message-text-color);
        border-bottom-left-radius: 4px;
      }
      .message-wrapper.gemini .message-content {
          background-color: #2c3e50 !important;
          color: #ecf0f1;
      }
      .message-wrapper.system .message-content { /* Added system message style */
          background-color: var(--system-message-bg);
          color: var(--system-message-text-color);
          font-size: 12px;
          font-style: italic;
      }
      .message-meta {
        font-size: 11px;
        opacity: 0.7;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
      }
      .message-wrapper.me .message-meta {
        text-align: right;
        flex-direction: row-reverse;
      }
      .message-wrapper.other .message-meta {
        text-align: left;
      }
      .read-receipts {
        font-size: 10px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }
      .read-receipts .fa-check {
          color: #a0a0a0;
      }
      .read-receipts .seen {
          color: var(--accent-color);
      }
      .message-composer {
        display: flex;
        padding: 15px 20px;
        background: var(--bg-light);
        border-top: 1px solid var(--border-color);
        gap: 10px;
        position: relative;
      }
      .message-composer input {
        flex: 1;
        padding: 12px 15px;
        border-radius: 25px;
        border: 1px solid var(--border-color);
        background: var(--input-bg);
        color: var(--text-color);
        font-size: 15px;
        outline: none;
      }
      .message-composer input::placeholder {
        color: #999;
      }
      .message-composer button {
        padding: 12px 20px;
        border-radius: 25px;
        border: none;
        background: var(--accent-color);
        color: white;
        cursor: pointer;
        font-size: 15px;
        transition: background-color 0.2s ease;
      }
      .message-composer button:hover {
        background-color: var(--hover-color);
      }
      .message-composer .icon-btn {
          width: 50px;
          padding: 0;
          border-radius: 50%;
          background: #2ecc71;
      }
      .message-composer .icon-btn i {
          font-size: 20px;
      }
      .message-composer .voice-btn { background: #3498db; }
      .message-composer .camera-btn { background: #9b59b6; }
      .room-initial-selection {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 20px;
        background-color: var(--bg-dark);
      }
      .room-initial-selection h2 {
        color: var(--text-color);
        margin-bottom: 20px;
      }
      .room-initial-selection p {
        color: #aaa;
        margin-bottom: 30px;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
      }
      .modal-content {
        background-color: var(--bg-light);
        margin: 5% auto;
        padding: 20px;
        border: 1px solid var(--border-color);
        width: 80%;
        max-width: 500px;
        border-radius: 10px;
      }
      .modal-content h3 {
          margin-top: 0;
          color: var(--text-color);
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .close:hover,
      .close:focus {
        color: #e74c3c;
        text-decoration: none;
        cursor: pointer;
      }
      .color-options {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          justify-content: center;
          flex-wrap: wrap;
      }
      .color-option {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 2px solid transparent;
          cursor: pointer;
          transition: border-color 0.2s ease;
      }
      .color-option:hover {
          border-color: var(--accent-color);
      }
      .color-option.selected {
          border-color: var(--accent-color);
          box-shadow: 0 0 0 3px var(--accent-color);
      }
      .theme-options {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
      }
      .theme-options button {
          padding: 10px;
          border: 1px solid var(--border-color);
          border-radius: 5px;
          background-color: var(--input-bg);
          color: var(--text-color);
          cursor: pointer;
      }
      .theme-options button.selected {
          background-color: var(--accent-color);
          color: white;
      }
      .setting-group {
          margin-bottom: 20px;
      }
      .setting-group label {
          display: block;
          margin-bottom: 5px;
          color: var(--text-color);
      }
      .setting-group input, .setting-group select {
          width: 100%;
          padding: 10px;
          box-sizing: border-box;
          border-radius: 5px;
          border: 1px solid var(--border-color);
          background-color: var(--input-bg);
          color: var(--text-color);
          margin-bottom: 10px;
      }
      .message-options {
          position: fixed;
          background-color: var(--bg-light);
          border: 1px solid var(--border-color);
          border-radius: 5px;
          padding: 5px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          display: none;
          z-index: 1000;
          white-space: nowrap;
          transform: translate(-50%, -50%);
          left: 50%;
          top: 50%;
      }
      .message-options button {
          background: none;
          border: none;
          color: var(--text-color);
          padding: 8px 12px;
          width: 100%;
          text-align: right;
          cursor: pointer;
      }
      .message-options button:hover {
          background-color: var(--input-bg);
      }
      .kick-user-btn {
        background: #e74c3c !important;
        color: white !important;
        margin-top: 10px;
      }
      .kick-user-btn:hover {
        background: #c0392b !important;
      }
      .recording-status {
        color: #e74c3c;
        font-size: 12px;
        margin-right: 10px;
        display: none;
      }

      /* Members Modal Styles */
      .members-modal-content {
          background-color: var(--bg-light);
          margin: 5% auto;
          padding: 20px;
          border: 1px solid var(--border-color);
          width: 80%;
          max-width: 400px;
          border-radius: 10px;
      }
      .members-modal-content h3 {
          margin-top: 0;
          color: var(--text-color);
      }
      .members-list {
          list-style: none;
          padding: 0;
          max-height: 200px;
          overflow-y: auto;
      }
      .members-list li {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px;
          border-bottom: 1px solid var(--border-color);
          cursor: pointer;
      }
      .members-list li:hover {
          background-color: var(--input-bg);
      }
      .members-list li:last-child {
          border-bottom: none;
      }
      .members-list .member-name {
          font-weight: bold;
      }
      .members-list .kick-btn {
          background-color: #e74c3c;
          color: white;
          border: none;
          padding: 5px 10px;
          border-radius: 5px;
          cursor: pointer;
          font-size: 12px;
      }
      .members-list .kick-btn:hover {
          background-color: #c0392b;
      }
      .add-member-form {
          display: flex;
          margin-top: 20px;
          gap: 10px;
      }
      .add-member-form input {
          flex: 1;
          padding: 8px;
          border-radius: 5px;
          border: 1px solid var(--border-color);
          background-color: var(--input-bg);
          color: var(--text-color);
      }
      .add-member-form button {
          background-color: var(--accent-color);
          color: white;
          border: none;
          padding: 8px 12px;
          border-radius: 5px;
          cursor: pointer;
      }

      /* Profile Modal */
      #profileModal .modal-content {
          max-width: 400px;
          text-align: center;
      }
      #profileModal h3 {
          margin-bottom: 10px;
      }
      #profileModal p {
          color: #aaa;
          margin: 5px 0;
      }
      
      /* Login/Signup Styles */
      .login-container {
          background-color: #2c2c44;
          padding: 40px;
          border-radius: 10px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
          width: 90%;
          max-width: 400px;
          text-align: center;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
      }
      .login-container h2 {
          margin-bottom: 20px;
          color: #fff;
      }
      .input-group {
          margin-bottom: 20px;
          text-align: right;
      }
      .input-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: bold;
      }
      .input-group input {
          width: 100%;
          padding: 12px;
          border: 1px solid #44445c;
          border-radius: 5px;
          background-color: #3c3c54;
          color: #e0e0e0;
          font-size: 16px;
          box-sizing: border-box;
          direction: rtl;
      }
      .input-group input:focus {
          outline: none;
          border-color: #0b5edd;
      }
      .btn {
          width: 100%;
          padding: 12px;
          border: none;
          border-radius: 5px;
          background-color: #0b5edd;
          color: #fff;
          font-size: 16px;
          cursor: pointer;
          transition: background-color 0.2s ease;
      }
      .btn:hover {
          background-color: #0d6efd;
      }
      .toggle-btn {
          background: none;
          color: #0b5edd;
          border: none;
          cursor: pointer;
          margin-top: 15px;
          font-size: 14px;
      }
      .message {
          color: #e74c3c;
          margin-top: 10px;
          display: none;
      }

      /* Game Modal */
      #gameModal .modal-content {
        max-width: 350px;
        text-align: center;
      }
      #gameModal .game-board {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
        background-color: var(--border-color);
        padding: 5px;
        border-radius: 5px;
      }
      #gameModal .game-cell {
        width: 100px;
        height: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: var(--bg-dark);
        color: var(--text-color);
        font-size: 48px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 5px;
      }
      #gameModal .game-cell:hover:empty {
        background-color: var(--input-bg);
      }
      #gameModal .game-cell.x {
        color: red;
        font-size: 72px;
      }
      #gameModal .game-cell.o {
        color: red;
        font-size: 72px;
      }
      #gameModal .game-status {
        margin-top: 15px;
        font-size: 18px;
        font-weight: bold;
      }
      .game-options {
          list-style: none;
          padding: 0;
      }
      .game-options li {
          margin-bottom: 10px;
      }
      .game-options button {
          width: 100%;
          padding: 10px;
          border: 1px solid var(--border-color);
          border-radius: 5px;
          background-color: var(--input-bg);
          color: var(--text-color);
          cursor: pointer;
      }
      .game-options button:hover {
          background-color: var(--accent-color);
          color: white;
      }

      /* Autocomplete Suggestions */
      #autocomplete-suggestions {
          position: absolute;
          bottom: 100%;
          left: 0;
          right: 0;
          background-color: var(--bg-light);
          border: 1px solid var(--border-color);
          border-radius: 8px;
          margin-bottom: 5px;
          max-height: 150px;
          overflow-y: auto;
          box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
          z-index: 50;
          display: none;
      }
      #autocomplete-suggestions ul {
          list-style: none;
          padding: 0;
          margin: 0;
      }
      #autocomplete-suggestions li {
          padding: 10px 15px;
          cursor: pointer;
          color: var(--text-color);
      }
      #autocomplete-suggestions li:hover {
          background-color: var(--input-bg);
      }
    </style>
  </head>
  <body>
    <div id="loginSection" class="login-container">
        <h2 id="form-title">تسجيل الدخول</h2>
        <p>لا يمكنك استخدام التطبيق بدون تسجيل الدخول أو إنشاء حساب جديد.</p>
        <div class="input-group">
            <label for="email">البريد الإلكتروني</label>
            <input type="email" id="email" name="email" placeholder="أدخل بريدك الإلكتروني" required>
        </div>
        <div class="input-group">
            <label for="password">كلمة المرور</label>
            <input type="password" id="password" name="password" placeholder="أدخل كلمة المرور" required>
        </div>
        <div id="username-group" class="input-group" style="display: none;">
            <label for="displayName">اسم العرض</label>
            <input type="text" id="displayName" name="displayName" placeholder="اختر اسم للعرض" required>
        </div>
        <button id="main-btn" class="btn">تسجيل الدخول</button>
        <p id="message" class="message"></p>
        <button id="toggle-form" class="toggle-btn">
            لا تملك حسابًا؟ إنشاء حساب
        </button>
    </div>

    <div id="chatSection" class="app" style="display: none;">
      <button id="sidebarToggleBtn" class="sidebar-toggle-btn"><i class="fas fa-bars"></i></button>

      <div id="sidebar" class="sidebar">
        <div class="user-info">
          مرحباً بك: <span id="meName"></span>
        </div>
        <h3>الغرف المتاحة</h3>
        <ul id="roomList" class="room-list"></ul>
        <button class="add-room-btn" id="addRoomBtn">انضم/أنشئ غرفة</button>
      </div>

      <div class="chat-main">
        <div id="roomInitialSelection" class="room-initial-selection">
          <h2>أهلاً بك في الشات!</h2>
          <p>اختر غرفة من القائمة الجانبية أو انشئ/انضم لغرفة جديدة للبدء.</p>
        </div>

        <div id="chatRoomArea" style="display: none; height: 100%; flex-direction: column;">
          <div class="chat-header">
            <h2 id="currentRoomName"></h2>
            <div class="header-actions">
              <button class="settings-btn" id="aboutBtn"><i class="fas fa-info-circle"></i></button>
              <button class="settings-btn" id="membersBtn"><i class="fas fa-users"></i></button>
              <button class="settings-btn" id="roomSettingsBtn"><i class="fas fa-cog"></i></button>
              <button class="settings-btn" id="userSettingsBtn"><i class="fas fa-user-cog"></i></button>
            </div>
          </div>
          <div id="messagesArea" class="messages-area"></div>
          <div class="message-composer">
            <div id="autocomplete-suggestions">
                <ul>
                    <li id="gemi-suggestion">@gemini</li>
                </ul>
            </div>
            <span id="recordingStatus" class="recording-status">تسجيل...</span>
            <input id="textInput" type="text" placeholder="اكتب رسالتك..." autocomplete="off" />
            <button class="icon-btn" id="fileBtn"><i class="fas fa-paperclip"></i></button>
            <input type="file" id="fileInput" style="display: none;" />
            <button class="icon-btn voice-btn" id="voiceBtn"><i class="fas fa-microphone"></i></button>
            <button class="icon-btn camera-btn" id="cameraBtn"><i class="fas fa-camera"></i></button>
            <input type="file" id="cameraInput" accept="image/*" style="display: none;" capture="user" />
            <button id="sendBtn">إرسال</button>
          </div>
        </div>
      </div>
    </div>

    <div id="userSettingsModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeUserSettingsModal">&times;</span>
        <h3>إعدادات المستخدم</h3>
        <div class="setting-group">
            <label for="usernameInput">تغيير اسم العرض</label>
            <input type="text" id="usernameInput" placeholder="أدخل اسمك الجديد" />
            <button id="saveUsernameBtn">حفظ الاسم</button>
        </div>
        <div class="setting-group">
            <label for="bioInput">النبذة الشخصية</label>
            <input type="text" id="bioInput" placeholder="اكتب نبذة مختصرة عنك" />
        </div>
        <div class="setting-group">
            <label>اختر لون رسائلك</label>
            <div id="colorOptions" class="color-options">
              <div class="color-option" data-color="#0b5edd" style="background-color: #0b5edd;"></div>
              <div class="color-option" data-color="#2ecc71" style="background-color: #2ecc71;"></div>
              <div class="color-option" data-color="#e74c3c" style="background-color: #e74c3c;"></div>
              <div class="color-option" data-color="#f39c12" style="background-color: #f39c12;"></div>
              <div class="color-option" data-color="#9b59b6" style="background-color: #9b59b6;"></div>
            </div>
        </div>
        <div class="setting-group">
            <label>اختر ثيم البرنامج</label>
            <div id="themeOptions" class="theme-options">
                <button data-theme="dark" class="selected">داكن</button>
                <button data-theme="light">فاتح</button>
            </div>
        </div>
        <div class="setting-group">
            <label for="fontFamilySelect">نوع الخط</label>
            <select id="fontFamilySelect">
                <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                <option value="'Arial', sans-serif">Arial</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="'Cairo', sans-serif">Cairo</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="fontSizeSelect">حجم الخط</label>
            <select id="fontSizeSelect">
                <option value="14px">صغير</option>
                <option value="15px">متوسط</option>
                <option value="16px">كبير</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="chatBackgroundInput">خلفية الشات (صورة/لون)</label>
            <input type="text" id="chatBackgroundInput" placeholder="أدخل رابط صورة أو كود لون (#000)" />
            <button id="saveBackgroundBtn">حفظ الخلفية</button>
        </div>
        <button id="logoutBtn" class="btn" style="background-color: #e74c3c;">تسجيل خروج</button>
      </div>
    </div>
    
    <div id="roomSettingsModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeRoomSettingsModal">&times;</span>
        <h3>إعدادات الغرفة</h3>
        <div class="setting-group">
            <label>مالك الغرفة:</label>
            <p id="roomOwnerName"></p>
        </div>
        <div class="setting-group">
            <button id="leaveRoomBtn" class="btn" style="background-color: #f39c12;">الخروج من الغرفة</button>
            <button id="deleteRoomBtn" class="btn" style="background-color: #e74c3c; display: none;">حذف الغرفة</button>
        </div>
      </div>
    </div>

    <div id="aboutModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAboutModal">&times;</span>
        <h3 style="font-size: 24px; color: #e74c3c; margin-bottom: 20px;">Developed By Sara_1383</h3>
        <h3>عن التطبيق</h3>
        <p>أهلاً بك في تطبيق الدردشة متعدد الغرف. أهم الميزات في التطبيق هي:</p>
        <ul>
            <li>**دردشة جماعية:** تقدر تنضم أو تعمل غرف دردشة مختلفة.</li>
            <li>**إعدادات شخصية:** تقدر تعدل على مظهر الشات وألوان رسائلك عشان تخليه مناسب ليك.</li>
            <li>**إرسال الوسائط:** تقدر تبعت رسائل نصية، صور، ملفات، وتسجيلات صوتية.</li>
            <li>**إشعارات القراءة:** بتظهر علامات صح عشان تعرف إذا كان الأعضاء التانيين قرو رسالتك ولا لأ:</li>
            <ul>
                <li><i class="fas fa-check" style="color: #a0a0a0;"></i> **علامة صح واحدة رمادي:** الرسالة اتبعتت.</li>
                <li><i class="fas fa-check" style="color: #a0a0a0;"></i><i class="fas fa-check" style="color: var(--accent-color);"></i> **علامتين صح أزرق:** الرسالة وصلت وقراها واحد على الأقل.</li>
                <li><i class="fas fa-check seen"></i> **علامتين صح أزرق:** الرسالة وصلت وقراها كل الأعضاء في الغرفة.</li>
            </ul>
        </ul>
    </div>
    </div>
    <div id="membersModal" class="modal">
      <div class="members-modal-content">
        <span class="close" id="closeMembersModal">&times;</span>
        <h3>أعضاء الغرفة</h3>
        <ul id="membersList" class="members-list"></ul>
        <div class="add-member-form">
            <input type="text" id="addMemberInput" placeholder="أدخل اسم المستخدم" />
            <button id="addMemberBtn">إضافة عضو</button>
        </div>
      </div>
    </div>
    <div id="profileModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeProfileModal">&times;</span>
        <h3 id="profileName"></h3>
        <p id="profileUsername"></p>
        <p id="profileBio"></p>
      </div>
    </div>
    <div id="gamesMenuModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeGamesModal">&times;</span>
        <h3>اختر لعبة</h3>
        <ul class="game-options">
            <li><button id="startXOBtn">XO</button></li>
        </ul>
      </div>
    </div>
    <div id="gameModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeGameModal">&times;</span>
        <h3 id="gameTitle">XO</h3>
        <div id="game-board" class="game-board">
          <div class="game-cell" data-index="0"></div>
          <div class="game-cell" data-index="1"></div>
          <div class="game-cell" data-index="2"></div>
          <div class="game-cell" data-index="3"></div>
          <div class="game-cell" data-index="4"></div>
          <div class="game-cell" data-index="5"></div>
          <div class="game-cell" data-index="6"></div>
          <div class="game-cell" data-index="7"></div>
          <div class="game-cell" data-index="8"></div>
        </div>
        <div id="game-status" class="game-status"></div>
        <button id="resetGameBtn" style="display: none; margin-top: 15px;">إعادة اللعبة</button>
        <button id="exitGameBtn" style="display: none; margin-top: 15px; margin-right: 10px;">الخروج من اللعبة</button>
      </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
      // **هام جداً: استبدل هذا الكود بـ firebaseConfig الخاص بمشروعك**
      // **WARNING: Replace this code with your own firebaseConfig**
      const firebaseConfig = {
          apiKey: "AIzaSyBrDei5ZlZIJk0-aOBhJNBg_EZtvrTXSAg",
          authDomain: "chat-138313.firebaseapp.com",
          projectId: "chat-138313",
          storageBucket: "chat-138313.firebasestorage.app",
          messagingSenderId: "135870025518",
          appId: "1:135870025518:web:2837be4cd093307527f4bf",
          measurementId: "G-9C90109N5X"
      };
      firebase.initializeApp(firebaseConfig);

      // **أضف الـ API Key الخاص بـ Gemini هنا**
      const GEMINI_API_KEY = "AIzaSyAuXxIC3OfSCURyxyBn2Tkd6uWD66LvyzY";

      const db = firebase.database();
      const storage = firebase.storage();
      const auth = firebase.auth();

      let userId = null;
      let myName = "ضيف";
      let myColor = '#0b5edd';
      let myTheme = 'dark';
      let myFontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
      let myFontSize = '15px';
      let myChatBackground = '';
      let myBio = '';

      // UI Elements
      const loginSection = document.getElementById('loginSection');
      const chatSection = document.getElementById('chatSection');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const displayNameInput = document.getElementById('displayName');
      const usernameGroup = document.getElementById('username-group');
      const mainBtn = document.getElementById('main-btn');
      const toggleFormBtn = document.getElementById('toggle-form');
      const formTitle = document.getElementById('form-title');
      const messageEl = document.getElementById('message');
      
      let isSignUp = false;

      // New Login/Signup Logic
      toggleFormBtn.addEventListener('click', () => {
          isSignUp = !isSignUp;
          if (isSignUp) {
              formTitle.innerText = "إنشاء حساب";
              mainBtn.innerText = "إنشاء حساب";
              toggleFormBtn.innerText = "لديك حساب بالفعل؟ تسجيل الدخول";
              usernameGroup.style.display = 'block';
          } else {
              formTitle.innerText = "تسجيل الدخول";
              mainBtn.innerText = "تسجيل الدخول";
              toggleFormBtn.innerText = "لا تملك حسابًا؟ إنشاء حساب";
              usernameGroup.style.display = 'none';
          }
      });
      
      mainBtn.addEventListener('click', async () => {
          const email = emailInput.value;
          const password = passwordInput.value;
          messageEl.style.display = 'none';

          if (!email || !password) {
              messageEl.innerText = "البريد الإلكتروني وكلمة المرور مطلوبان.";
              messageEl.style.display = 'block';
              return;
          }

          try {
              if (isSignUp) {
                  const displayName = displayNameInput.value;
                  if (!displayName) {
                      messageEl.innerText = "اسم العرض مطلوب.";
                      messageEl.style.display = 'block';
                      return;
                  }
                  const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                  await userCredential.user.updateProfile({ displayName: displayName });
                  await db.ref('users/' + userCredential.user.uid).set({
                      name: displayName,
                      email: email,
                      color: myColor,
                      bio: myBio,
                      createdAt: firebase.database.ServerValue.TIMESTAMP
                  });
              } else {
                  await auth.signInWithEmailAndPassword(email, password);
              }
          } catch (error) {
              messageEl.innerText = error.message;
              messageEl.style.display = 'block';
          }
      });
      
      auth.onAuthStateChanged(user => {
          if (user) {
              userId = user.uid;
              db.ref('users/' + userId).once('value', snapshot => {
                  const userData = snapshot.val();
                  if (userData) {
                      myName = userData.name || user.displayName;
                      myColor = userData.color || myColor;
                      myBio = userData.bio || myBio;
                  } else {
                      myName = user.displayName;
                  }
                  
                  document.getElementById('meName').innerText = myName;
                  document.documentElement.className = myTheme + '-theme';
                  document.documentElement.style.setProperty('--font-family', myFontFamily);
                  document.documentElement.style.setProperty('--font-size', myFontSize);
                  if (myChatBackground.startsWith('#')) {
                      document.documentElement.style.setProperty('--chat-bg-color', myChatBackground);
                      document.documentElement.style.setProperty('--chat-bg-image', 'none');
                  } else if (myChatBackground) {
                      document.documentElement.style.setProperty('--chat-bg-image', `url('${myChatBackground}')`);
                      document.documentElement.style.setProperty('--chat-bg-color', 'transparent');
                  }
                  document.documentElement.style.setProperty('--my-message-bg', myColor);
                  
                  loginSection.style.display = 'none';
                  chatSection.style.display = 'flex';
                  fetchAllRooms();
              });
          } else {
              loginSection.style.display = 'block';
              chatSection.style.display = 'none';
          }
      });
      
      // End of Login/Signup Logic
      
      const sidebar = document.getElementById('sidebar');
      const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
      const roomListEl = document.getElementById('roomList');
      const addRoomBtn = document.getElementById('addRoomBtn');
      const aboutBtn = document.getElementById('aboutBtn');
      const userSettingsBtn = document.getElementById('userSettingsBtn');
      const roomSettingsBtn = document.getElementById('roomSettingsBtn');
      const membersBtn = document.getElementById('membersBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const userSettingsModal = document.getElementById('userSettingsModal');
      const roomSettingsModal = document.getElementById('roomSettingsModal');
      const aboutModal = document.getElementById('aboutModal');
      const membersModal = document.getElementById('membersModal');
      const profileModal = document.getElementById('profileModal');
      const closeUserSettingsModal = document.getElementById('closeUserSettingsModal');
      const closeRoomSettingsModal = document.getElementById('closeRoomSettingsModal');
      const closeAboutModal = document.getElementById('closeAboutModal');
      const closeMembersModal = document.getElementById('closeMembersModal');
      const closeProfileModal = document.getElementById('closeProfileModal');
      const usernameInput = document.getElementById('usernameInput');
      const saveUsernameBtn = document.getElementById('saveUsernameBtn');
      const bioInput = document.getElementById('bioInput');
      const colorOptionsEl = document.getElementById('colorOptions');
      const themeOptionsEl = document.getElementById('themeOptions');
      const fontFamilySelect = document.getElementById('fontFamilySelect');
      const fontSizeSelect = document.getElementById('fontSizeSelect');
      const chatBackgroundInput = document.getElementById('chatBackgroundInput');
      const saveBackgroundBtn = document.getElementById('saveBackgroundBtn');
      const currentRoomNameEl = document.getElementById('currentRoomName');
      const messagesArea = document.getElementById('messagesArea');
      const textInput = document.getElementById('textInput');
      const sendBtn = document.getElementById('sendBtn');
      const addMemberInput = document.getElementById('addMemberInput');
      const addMemberBtn = document.getElementById('addMemberBtn');
      const fileBtn = document.getElementById('fileBtn');
      const fileInput = document.getElementById('fileInput');
      const voiceBtn = document.getElementById('voiceBtn');
      const cameraBtn = document.getElementById('cameraBtn');
      const cameraInput = document.getElementById('cameraInput');
      const recordingStatus = document.getElementById('recordingStatus');
      const leaveRoomBtn = document.getElementById('leaveRoomBtn');
      const deleteRoomBtn = document.getElementById('deleteRoomBtn');
      const autocompleteSuggestionsEl = document.getElementById('autocomplete-suggestions');
      const gemiSuggestionEl = document.getElementById('gemi-suggestion');

      // New code for sidebar toggle
      sidebarToggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('active');
        sidebarToggleBtn.classList.toggle('active');
      });

      let activeRoomId = null;
      let roomOwnerId = null;
      let roomMembers = {};
      let typingTimers = {};
      let myTypingRef = null;
      let recording = false;
      let mediaRecorder;
      let audioChunks = [];

      function showModal(modal) {
          modal.style.display = 'block';
      }

      function closeModal(modal) {
          modal.style.display = 'none';
      }

      closeUserSettingsModal.onclick = () => closeModal(userSettingsModal);
      closeRoomSettingsModal.onclick = () => closeModal(roomSettingsModal);
      closeAboutModal.onclick = () => closeModal(aboutModal);
      closeMembersModal.onclick = () => closeModal(membersModal);
      closeProfileModal.onclick = () => closeModal(profileModal);
      window.onclick = (event) => {
          if (event.target == userSettingsModal) closeModal(userSettingsModal);
          if (event.target == roomSettingsModal) closeModal(roomSettingsModal);
          if (event.target == aboutModal) closeModal(aboutModal);
          if (event.target == membersModal) closeModal(membersModal);
          if (event.target == profileModal) closeModal(profileModal);
      };

      userSettingsBtn.onclick = () => {
          usernameInput.value = myName;
          bioInput.value = myBio;
          chatBackgroundInput.value = myChatBackground;
          document.querySelectorAll('.color-option').forEach(el => {
              el.classList.remove('selected');
              if (el.dataset.color === myColor) {
                  el.classList.add('selected');
              }
          });
          document.querySelectorAll('#themeOptions button').forEach(btn => {
              btn.classList.remove('selected');
              if (btn.dataset.theme === myTheme) {
                  btn.classList.add('selected');
              }
          });
          fontFamilySelect.value = myFontFamily;
          fontSizeSelect.value = myFontSize;
          showModal(userSettingsModal);
      };

      roomSettingsBtn.onclick = () => {
          if (!activeRoomId) return;
          db.ref('rooms/' + activeRoomId).once('value', snapshot => {
              const room = snapshot.val();
              roomOwnerId = room.owner;
              document.getElementById('roomOwnerName').innerText = room.ownerName;
              if (room.owner === userId) {
                  deleteRoomBtn.style.display = 'block';
              } else {
                  deleteRoomBtn.style.display = 'none';
              }
              showModal(roomSettingsModal);
          });
      };
      
      aboutBtn.onclick = () => showModal(aboutModal);
      membersBtn.onclick = () => {
          fetchRoomMembers(activeRoomId);
          showModal(membersModal);
      };

      function fetchAllRooms() {
          roomListEl.innerHTML = '';
          db.ref('users_rooms/' + userId).on('child_added', snapshot => {
              const roomId = snapshot.key;
              db.ref('rooms/' + roomId).once('value', roomSnapshot => {
                  const room = roomSnapshot.val();
                  if (room) {
                      addRoomToList(roomId, room.name);
                  }
              });
          });
          // Handle room removal from user's list
          db.ref('users_rooms/' + userId).on('child_removed', snapshot => {
              const roomId = snapshot.key;
              const roomItem = document.querySelector(`[data-id="${roomId}"]`).parentNode;
              if (roomItem) {
                  roomItem.remove();
              }
              if (activeRoomId === roomId) {
                  activeRoomId = null;
                  document.getElementById('chatRoomArea').style.display = 'none';
                  document.getElementById('roomInitialSelection').style.display = 'flex';
              }
          });
      }
      
      function addRoomToList(roomId, roomName) {
          if (document.querySelector(`[data-id="${roomId}"]`)) {
              return;
          }
          const li = document.createElement('li');
          const button = document.createElement('button');
          button.innerText = roomName;
          button.dataset.id = roomId;
          button.onclick = () => joinRoom(roomId, roomName);
          li.appendChild(button);

          const gamesBtn = document.createElement('button');
          gamesBtn.className = 'games-menu-btn';
          gamesBtn.innerHTML = '<i class="fas fa-gamepad"></i>';
          gamesBtn.onclick = (e) => {
              e.stopPropagation();
              initGamesMenu(roomId);
          };
          li.appendChild(gamesBtn);

          roomListEl.appendChild(li);
      }

      function joinRoom(roomId, roomName) {
          if (activeRoomId) {
              db.ref('messages/' + activeRoomId).off('child_added');
              db.ref('typing/' + activeRoomId).off('value');
              db.ref('rooms/' + activeRoomId).child('members').off('value');
          }
          activeRoomId = roomId;
          currentRoomNameEl.innerText = roomName;
          messagesArea.innerHTML = '';
          document.getElementById('roomInitialSelection').style.display = 'none';
          document.getElementById('chatRoomArea').style.display = 'flex';
          
          document.querySelectorAll('.room-list button').forEach(btn => btn.classList.remove('active'));
          document.querySelector(`[data-id="${roomId}"]`).classList.add('active');

          db.ref('messages/' + roomId).on('child_added', snapshot => {
              const message = snapshot.val();
              displayMessage(message, snapshot.key);
          });
          
          db.ref('rooms/' + roomId).child('members').on('value', snapshot => {
              roomMembers[roomId] = snapshot.val();
          });

          myTypingRef = db.ref('typing/' + roomId + '/' + userId);
          db.ref('typing/' + roomId).on('value', snapshot => {
              const typingUsers = snapshot.val();
              updateTypingStatus(typingUsers);
          });
          
          db.ref('messages/' + roomId).once('value', snapshot => {
              snapshot.forEach(childSnapshot => {
                  const messageId = childSnapshot.key;
                  const messageRef = db.ref('messages/' + roomId + '/' + messageId + '/reads');
                  messageRef.child(userId).set(true);
              });
          });
      }

      async function leaveRoom(roomId) {
          if (activeRoomId === roomId) {
              await sendMessage(`خرج من الغرفة.`, 'system');
              db.ref('users_rooms/' + userId + '/' + roomId).remove();
              db.ref('rooms/' + roomId + '/members/' + userId).remove();
              activeRoomId = null;
              document.getElementById('chatRoomArea').style.display = 'none';
              document.getElementById('roomInitialSelection').style.display = 'flex';
              closeModal(roomSettingsModal);
          }
      }

      async function deleteRoom(roomId) {
          if (!confirm('هل أنت متأكد من حذف هذه الغرفة نهائياً؟')) return;
          const roomRef = db.ref('rooms/' + roomId);
          const roomSnapshot = await roomRef.once('value');
          const roomData = roomSnapshot.val();
          if (roomData && roomData.owner === userId) {
              // Send system message to all members before deleting
              const members = roomData.members;
              for (const memberId in members) {
                  db.ref('users_rooms/' + memberId + '/' + roomId).remove();
              }
              await roomRef.remove();
              await db.ref(`messages/${roomId}`).remove();
              activeRoomId = null;
              document.getElementById('chatRoomArea').style.display = 'none';
              document.getElementById('roomInitialSelection').style.display = 'flex';
              closeModal(roomSettingsModal);
          } else {
              alert('ليس لديك الصلاحية لحذف هذه الغرفة.');
          }
      }

      addRoomBtn.addEventListener('click', async () => {
          const roomName = prompt('اكتب اسم الغرفة الجديدة:');
          if (roomName) {
              const newRoomRef = db.ref('rooms').push();
              const roomId = newRoomRef.key;
              await newRoomRef.set({
                  name: roomName,
                  createdAt: firebase.database.ServerValue.TIMESTAMP,
                  owner: userId,
                  ownerName: myName,
                  members: { [userId]: true }
              });
              await db.ref('users_rooms/' + userId + '/' + roomId).set(true);
              joinRoom(roomId, roomName);
          }
      });
      
      function displayMessage(message, messageId) {
          const messageWrapper = document.createElement('div');
          messageWrapper.classList.add('message-wrapper');
          
          if (message.type === 'system') {
              messageWrapper.classList.add('system');
              const messageContent = document.createElement('div');
              messageContent.classList.add('message-content');
              const textNode = document.createElement('p');
              textNode.innerText = message.text;
              messageContent.appendChild(textNode);
              messageWrapper.appendChild(messageContent);
              messagesArea.appendChild(messageWrapper);
          } else {
              const isMine = message.senderId === userId;
              messageWrapper.classList.add(isMine ? 'me' : 'other');
              if (message.senderId === 'gemini') {
                  messageWrapper.classList.remove('other');
                  messageWrapper.classList.add('gemini');
              }
              
              const messageContent = document.createElement('div');
              messageContent.classList.add('message-content');
              
              const messageMeta = document.createElement('div');
              messageMeta.classList.add('message-meta');
              
              const senderName = document.createElement('span');
              senderName.classList.add('sender-name');
              senderName.innerText = message.senderName;
              if (message.user && message.user.color) {
                  senderName.style.color = message.user.color;
              }
              senderName.onclick = () => showUserProfile(message.senderId);
              
              const timestamp = document.createElement('span');
              timestamp.classList.add('timestamp');
              timestamp.innerText = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              
              messageMeta.appendChild(senderName);
              messageMeta.appendChild(timestamp);
              
              if (message.type === 'text') {
                  const textNode = document.createElement('p');
                  textNode.innerText = message.text;
                  messageContent.appendChild(textNode);
              } else if (message.type === 'image') {
                  const image = document.createElement('img');
                  image.src = message.url;
                  image.style.maxWidth = '100%';
                  image.style.borderRadius = '8px';
                  messageContent.appendChild(image);
              } else if (message.type === 'audio') {
                  const audio = document.createElement('audio');
                  audio.controls = true;
                  audio.src = message.url;
                  messageContent.appendChild(audio);
              } else if (message.type === 'file') {
                  const fileLink = document.createElement('a');
                  fileLink.href = message.url;
                  fileLink.innerText = message.text;
                  fileLink.target = "_blank";
                  messageContent.appendChild(fileLink);
              }
              
              messageWrapper.appendChild(messageMeta);
              messageWrapper.appendChild(messageContent);
              
              if (isMine) {
                  const readReceipts = document.createElement('div');
                  readReceipts.classList.add('read-receipts');
                  const check1 = document.createElement('i');
                  check1.className = 'fas fa-check';
                  const check2 = document.createElement('i');
                  check2.className = 'fas fa-check';
                  readReceipts.appendChild(check1);
                  readReceipts.appendChild(check2);
                  
                  db.ref('messages/' + activeRoomId + '/' + messageId + '/reads').on('value', readsSnapshot => {
                      const reads = readsSnapshot.val() || {};
                      const readCount = Object.keys(reads).length;
                      const membersCount = Object.keys(roomMembers[activeRoomId] || {}).length;

                      check1.style.color = (readCount > 1) ? 'var(--accent-color)' : '#a0a0a0';
                      check2.style.color = (readCount >= membersCount) ? 'var(--accent-color)' : '#a0a0a0';
                  });
                  
                  messageWrapper.appendChild(readReceipts);
              }
              
              messagesArea.appendChild(messageWrapper);
          }
          
          messagesArea.scrollTop = messagesArea.scrollHeight;
      }

      async function sendMessage(text, type = 'text', url = null) {
          if (!activeRoomId) return;
          
          const message = {
              senderId: userId,
              senderName: myName,
              text: text,
              type: type,
              timestamp: firebase.database.ServerValue.TIMESTAMP,
              user: {
                color: myColor
              }
          };

          if (type === 'system') {
              message.senderId = 'system';
              message.senderName = 'System';
          }
          if (url) {
              message.url = url;
          }

          const newMessageRef = db.ref('messages/' + activeRoomId).push();
          const messageId = newMessageRef.key;

          await newMessageRef.set(message);

          if (type !== 'system') {
              const messageReadsRef = db.ref('messages/' + activeRoomId + '/' + messageId + '/reads');
              messageReadsRef.child(userId).set(true);
          }
          
          textInput.value = '';
      }

      // New function to send message to Gemini
      async function sendToGemini(promptText) {
          const geminiMessage = {
              senderId: 'gemini',
              senderName: 'Gemini',
              text: 'جيميني بيفكر...',
              type: 'text',
              timestamp: firebase.database.ServerValue.TIMESTAMP
          };
          const loadingMessageRef = db.ref('messages/' + activeRoomId).push();
          await loadingMessageRef.set(geminiMessage);

          try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      contents: [{
                          parts: [{
                              text: promptText
                          }]
                      }]
                  })
              });
              const data = await response.json();
              if (data.candidates && data.candidates.length > 0) {
                  const geminiResponseText = data.candidates[0].content.parts[0].text;
                  await loadingMessageRef.update({
                      text: geminiResponseText,
                  });
              } else {
                  await loadingMessageRef.update({
                      text: "حصلت مشكلة. مش قادر أرد عليك دلوقتي.",
                  });
              }
          } catch (error) {
              console.error('Gemini API Error:', error);
              await loadingMessageRef.update({
                  text: "حصلت مشكلة في الاتصال بالخدمة.",
              });
          }
      }

      async function uploadFile(file) {
          if (!activeRoomId) return;

          const fileType = file.type.split('/')[0];
          const storageRef = storage.ref(`chat_files/${activeRoomId}/${file.name}`);
          const task = storageRef.put(file);

          task.on('state_changed',
              (snapshot) => {},
              (error) => {
                  console.error("Upload error:", error);
              },
              () => {
                  task.snapshot.ref.getDownloadURL().then((downloadURL) => {
                      const fileExtension = file.name.split('.').pop();
                      if (fileType === 'image') {
                          sendMessage(`صورة: ${file.name}`, 'image', downloadURL);
                      } else if (fileType === 'audio') {
                          sendMessage(`تسجيل صوتي`, 'audio', downloadURL);
                      } else {
                          sendMessage(`ملف: ${file.name}`, 'file', downloadURL);
                      }
                  });
              }
          );
      }

      sendBtn.addEventListener('click', () => {
          const text = textInput.value.trim();
          if (text) {
              if (text.startsWith('@gemini')) {
                  const promptText = text.substring('@gemini'.length).trim();
                  if (promptText) {
                      sendMessage(text);
                      sendToGemini(promptText);
                  }
              } else {
                  sendMessage(text);
              }
              if (myTypingRef) {
                  myTypingRef.remove();
              }
          }
      });

      // Autocomplete logic
      textInput.addEventListener('input', () => {
          const text = textInput.value;
          if (text.endsWith('@')) {
              autocompleteSuggestionsEl.style.display = 'block';
          } else {
              autocompleteSuggestionsEl.style.display = 'none';
          }
      });

      gemiSuggestionEl.addEventListener('click', () => {
          textInput.value = '@gemini ';
          textInput.focus();
          autocompleteSuggestionsEl.style.display = 'none';
      });

      textInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
              sendBtn.click();
          }
      });

      function updateTypingStatus(typingUsers) {
          const typingUsernames = [];
          if (typingUsers) {
              for (const id in typingUsers) {
                  if (id !== userId) {
                      db.ref('users/' + id + '/name').once('value').then(snapshot => {
                          if (snapshot.exists()) {
                              typingUsernames.push(snapshot.val());
                          }
                      });
                  }
              }
          }
      }

      addMemberBtn.onclick = async () => {
          const usernameToAdd = addMemberInput.value.trim();
          if (!usernameToAdd) {
              alert('ادخل اسم المستخدم المراد إضافته.');
              return;
          }

          const roomRef = db.ref('rooms/' + activeRoomId);
          const roomSnapshot = await roomRef.once('value');
          const roomData = roomSnapshot.val();

          if (roomData.owner !== userId) {
              alert('فقط مالك الغرفة يمكنه إضافة أعضاء.');
              return;
          }

          const userRef = db.ref('users').orderByChild('name').equalTo(usernameToAdd).once('value');
          userRef.then(async (snapshot) => {
              if (snapshot.exists()) {
                  let userToAddId = Object.keys(snapshot.val())[0];
                  let userToAddName = snapshot.val()[userToAddId].name;
                  
                  // Add user to the room and to the user's room list
                  await db.ref('rooms/' + activeRoomId + '/members/' + userToAddId).set(true);
                  await db.ref('users_rooms/' + userToAddId + '/' + activeRoomId).set(true);
                  
                  // Send system message
                  await sendMessage(`تم إضافة المستخدم ${userToAddName} بواسطة الأدمن ${myName}.`, 'system');
                  alert(`تم إضافة ${userToAddName} بنجاح!`);
                  addMemberInput.value = '';
                  fetchRoomMembers(activeRoomId); // Refresh members list
              } else {
                  alert('المستخدم غير موجود.');
              }
          });
      };


      function fetchRoomMembers(roomId) {
          const membersListEl = document.getElementById('membersList');
          membersListEl.innerHTML = '';
          db.ref('rooms/' + roomId + '/members').once('value').then(snapshot => {
              const members = snapshot.val();
              for (const memberId in members) {
                  db.ref('users/' + memberId).once('value').then(userSnapshot => {
                      const member = userSnapshot.val();
                      const li = document.createElement('li');
                      li.className = 'member-item';
                      li.innerHTML = `<span class="member-name" style="color:${member.color}">${member.name}</span>`;
                      li.onclick = () => showUserProfile(memberId);
                      db.ref('rooms/' + roomId).once('value').then(roomSnapshot => {
                          if (roomSnapshot.val().owner === userId && memberId !== userId) {
                              const kickBtn = document.createElement('button');
                              kickBtn.className = 'kick-btn';
                              kickBtn.innerText = 'طرد';
                              kickBtn.onclick = (e) => {
                                  e.stopPropagation();
                                  kickUser(roomId, memberId, member.name);
                              };
                              li.appendChild(kickBtn);
                          }
                          membersListEl.appendChild(li);
                      });
                  });
              }
          });
      }

      async function kickUser(roomId, kickedUserId, kickedUserName) {
          if (confirm(`هل أنت متأكد من طرد المستخدم ${kickedUserName}؟`)) {
              await db.ref('rooms/' + roomId + '/members/' + kickedUserId).remove();
              await db.ref('users_rooms/' + kickedUserId + '/' + roomId).remove();
              await sendMessage(`تم طرد المستخدم ${kickedUserName} بواسطة الأدمن ${myName}.`, 'system');
              fetchRoomMembers(roomId);
          }
      }

      function showUserProfile(profileId) {
          db.ref('users/' + profileId).once('value').then(snapshot => {
              const user = snapshot.val();
              document.getElementById('profileName').innerText = user.name;
              document.getElementById('profileUsername').innerText = user.email;
              document.getElementById('profileBio').innerText = user.bio || 'لا توجد نبذة شخصية';
              showModal(profileModal);
          });
      }

      colorOptionsEl.addEventListener('click', (e) => {
          if (e.target.classList.contains('color-option')) {
              document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
              const selectedColor = e.target.dataset.color;
              e.target.classList.add('selected');
              myColor = selectedColor;
              document.documentElement.style.setProperty('--my-message-bg', myColor);
              db.ref('users/' + userId + '/color').set(selectedColor);
          }
      });
      
      themeOptionsEl.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') {
              document.querySelectorAll('#themeOptions button').forEach(btn => btn.classList.remove('selected'));
              const selectedTheme = e.target.dataset.theme;
              e.target.classList.add('selected');
              myTheme = selectedTheme;
              document.documentElement.className = myTheme + '-theme';
          }
      });
      
      fontFamilySelect.addEventListener('change', (e) => {
          myFontFamily = e.target.value;
          document.documentElement.style.setProperty('--font-family', myFontFamily);
      });
      
      fontSizeSelect.addEventListener('change', (e) => {
          myFontSize = e.target.value;
          document.documentElement.style.setProperty('--font-size', myFontSize);
      });
      
      saveBackgroundBtn.addEventListener('click', () => {
          myChatBackground = chatBackgroundInput.value.trim();
          if (myChatBackground.startsWith('#')) {
              document.documentElement.style.setProperty('--chat-bg-color', myChatBackground);
              document.documentElement.style.setProperty('--chat-bg-image', 'none');
          } else if (myChatBackground) {
              document.documentElement.style.setProperty('--chat-bg-image', `url('${myChatBackground}')`);
              document.documentElement.style.setProperty('--chat-bg-color', 'transparent');
          } else {
              document.documentElement.style.setProperty('--chat-bg-image', 'none');
              document.documentElement.style.setProperty('--chat-bg-color', 'var(--bg-dark)');
          }
      });
      
      saveUsernameBtn.addEventListener('click', () => {
          const newName = usernameInput.value.trim();
          if (newName) {
              myName = newName;
              document.getElementById('meName').innerText = myName;
              db.ref('users/' + userId + '/name').set(newName);
              alert('تم حفظ الاسم بنجاح!');
          }
      });

      bioInput.addEventListener('change', (e) => {
          const newBio = e.target.value.trim();
          myBio = newBio;
          db.ref('users/' + userId + '/bio').set(newBio);
          alert('تم حفظ النبذة بنجاح!');
      });
      
      logoutBtn.addEventListener('click', () => {
          auth.signOut();
      });

      leaveRoomBtn.onclick = () => leaveRoom(activeRoomId);
      deleteRoomBtn.onclick = () => deleteRoom(activeRoomId);
      
      fileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
              uploadFile(file);
          }
      });

      cameraBtn.addEventListener('click', () => cameraInput.click());
      cameraInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
              uploadFile(file);
          }
      });
      
      voiceBtn.addEventListener('click', () => {
        if (recording) {
            mediaRecorder.stop();
            recording = false;
            recordingStatus.style.display = 'none';
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        } else {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    recording = true;
                    recordingStatus.style.display = 'inline';
                    voiceBtn.innerHTML = '<i class="fas fa-stop-circle"></i>';

                    mediaRecorder.ondataavailable = (e) => {
                        audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        uploadFile(audioBlob);
                        audioChunks = [];
                    };
                })
                .catch(e => console.error('Error with audio recording:', e));
        }
      });

      const messageOptionsEl = document.createElement('div');
      messageOptionsEl.className = 'message-options';
      const copyBtn = document.createElement('button');
      copyBtn.innerText = 'نسخ';
      const deleteBtn = document.createElement('button');
      deleteBtn.innerText = 'حذف';
      messageOptionsEl.appendChild(copyBtn);
      messageOptionsEl.appendChild(deleteBtn);
      document.body.appendChild(messageOptionsEl);

      document.addEventListener('contextmenu', (e) => {
        const messageWrapper = e.target.closest('.message-wrapper.me');
        if (messageWrapper) {
            e.preventDefault();
            const messageId = messageWrapper.dataset.id;
            const messageRef = db.ref('messages/' + activeRoomId + '/' + messageId);
            
            messageOptionsEl.style.display = 'block';
            messageOptionsEl.style.left = `${e.pageX}px`;
            messageOptionsEl.style.top = `${e.pageY}px`;

            copyBtn.onclick = () => {
                const text = messageWrapper.querySelector('p').innerText;
                navigator.clipboard.writeText(text);
                messageOptionsEl.style.display = 'none';
            };

            deleteBtn.onclick = () => {
                messageRef.remove();
                messageOptionsEl.style.display = 'none';
            };
        } else {
            messageOptionsEl.style.display = 'none';
        }
      });
      
      // Games
      const gamesMenuModal = document.getElementById('gamesMenuModal');
      const closeGamesModal = document.getElementById('closeGamesModal');
      const startXOBtn = document.getElementById('startXOBtn');
      const gameModal = document.getElementById('gameModal');
      const closeGameModal = document.getElementById('closeGameModal');
      const gameBoardEl = document.getElementById('game-board');
      const gameStatusEl = document.getElementById('game-status');
      const resetGameBtn = document.getElementById('resetGameBtn');
      const exitGameBtn = document.getElementById('exitGameBtn');

      let xoRef = null;
      let mySymbol = 'X';
      
      closeGamesModal.onclick = () => closeModal(gamesMenuModal);
      closeGameModal.onclick = () => closeModal(gameModal);
      
      function initGamesMenu(roomId) {
          closeGamesModal.onclick = () => closeModal(gamesMenuModal);
          startXOBtn.onclick = () => startXO(roomId);
          showModal(gamesMenuModal);
      }

      async function startXO(roomId) {
          closeModal(gamesMenuModal);
          showModal(gameModal);
          
          xoRef = db.ref('games/' + roomId + '/xo');
          const gameSnapshot = await xoRef.once('value');
          
          if (gameSnapshot.exists()) {
              const gameState = gameSnapshot.val();
              if (gameState.playerX && gameState.playerO) {
                  if (gameState.playerX === userId || gameState.playerO === userId) {
                      mySymbol = (gameState.playerX === userId) ? 'X' : 'O';
                  } else {
                       gameStatusEl.innerText = 'يوجد لعبة بالفعل. لا يمكنك الانضمام.';
                       resetGameBtn.style.display = 'none';
                       exitGameBtn.style.display = 'block';
                       disableXOCells();
                       return;
                  }
              } else if (gameState.playerX && !gameState.playerO) {
                  await xoRef.update({ playerO: userId });
                  mySymbol = 'O';
              } else if (!gameState.playerX) {
                  await xoRef.update({ playerX: userId });
                  mySymbol = 'X';
              }
          } else {
              await xoRef.set({
                  board: ['', '', '', '', '', '', '', '', ''],
                  currentPlayer: userId,
                  playerX: userId,
                  playerO: null,
                  status: `اللاعب ${myName} (X) هيبدأ...`,
                  winner: null
              });
              mySymbol = 'X';
          }
          
          xoRef.on('value', snapshot => {
              const gameState = snapshot.val();
              if (gameState) {
                  updateXOBoard(gameState);
              }
          });
          
          gameBoardEl.addEventListener('click', handleXOClick);
      }
      
      function updateXOBoard(gameState) {
          const board = gameState.board;
          const status = gameState.status;
          const currentPlayerId = gameState.currentPlayer;
          const winner = gameState.winner;
          
          gameStatusEl.innerText = status;
          document.querySelectorAll('.game-cell').forEach((cell, index) => {
              cell.innerText = board[index];
              cell.className = 'game-cell';
              if (board[index] === 'X') cell.classList.add('x');
              if (board[index] === 'O') cell.classList.add('o');
              cell.onclick = null;
              if (!winner && board[index] === '' && currentPlayerId === userId) {
                  cell.onclick = (e) => handleXOClick(e);
                  cell.dataset.index = index;
              }
          });
          
          if (winner) {
              disableXOCells();
              resetGameBtn.style.display = 'block';
              exitGameBtn.style.display = 'block';
          } else {
              resetGameBtn.style.display = 'none';
              exitGameBtn.style.display = 'block';
          }
      }

      function handleXOClick(event) {
          const index = event.target.dataset.index;
          if (index === undefined) return;
          
          xoRef.once('value').then(snapshot => {
              const gameState = snapshot.val();
              if (gameState.currentPlayer === userId && gameState.board[index] === '') {
                  const newBoard = [...gameState.board];
                  newBoard[index] = mySymbol;
                  
                  const nextPlayer = (mySymbol === 'X') ? gameState.playerO : gameState.playerX;
                  
                  xoRef.update({
                      board: newBoard,
                      currentPlayer: nextPlayer,
                      status: `دور اللاعب ${(mySymbol === 'X' ? 'O' : 'X')}`
                  });
                  
                  checkXOWinner(newBoard, mySymbol, xoRef, gameState.playerX, gameState.playerO);
              }
          });
      }
      
      function checkXOWinner(board, symbol, xoRef, playerXId, playerOId) {
          const winPatterns = [
              [0, 1, 2], [3, 4, 5], [6, 7, 8],
              [0, 3, 6], [1, 4, 7], [2, 5, 8],
              [0, 4, 8], [2, 4, 6]
          ];
          
          const isWinner = winPatterns.some(pattern => 
              pattern.every(index => board[index] === symbol)
          );
          
          if (isWinner) {
              const winnerId = (symbol === 'X') ? playerXId : playerOId;
              
              xoRef.update({
                  winner: winnerId,
                  status: `اللاعب ${myName} (${symbol}) فاز!`,
              });
              
              const userRef = db.ref('users/' + winnerId);
              userRef.once('value').then(userSnapshot => {
                  const userData = userSnapshot.val();
                  let currentXOScore = (userData.scores && userData.scores.xo) ? userData.scores.xo : 0;
                  userRef.child('scores/xo').set(currentXOScore + 1);
              });
          } else if (board.every(cell => cell !== '')) {
              xoRef.update({
                  status: 'تعادل!'
              });
          }
      }
      
      function disableXOCells() {
          document.querySelectorAll('.game-cell').forEach(cell => {
              cell.onclick = null;
          });
      }
      
      resetGameBtn.addEventListener('click', () => {
          xoRef.once('value').then(snapshot => {
              const gameState = snapshot.val();
              if (gameState) {
                  xoRef.update({
                      board: ['', '', '', '', '', '', '', '', ''],
                      currentPlayer: gameState.playerX,
                      winner: null,
                      status: `اللاعب ${myName} (${mySymbol}) هيبدأ...`
                  });
              }
          });
      });
      
      exitGameBtn.addEventListener('click', () => {
          xoRef.off('value');
          xoRef = null;
          gameModal.style.display = 'none';
      });

    </script>
  </body>
</html>
